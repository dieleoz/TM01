<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Completa - TM01 Troncal Magdalena</title>
    <link rel="stylesheet" href="css/tm01-design-system.css">
    <style>
        body {
            padding: var(--space-lg);
            background: var(--bg-main);
        }

        .header {
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-md);
        }

        .stat-card {
            background: var(--bg-light);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--tm01-primary);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--tm01-primary);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .wbs-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-top: var(--space-lg);
        }

        .wbs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .wbs-table th {
            background: var(--tm01-primary);
            color: white;
            padding: var(--space-md);
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .wbs-table td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
        }

        .wbs-table tr:hover {
            background: var(--bg-hover);
        }

        .capitulo-row {
            background: var(--tm01-primary);
            color: white;
            font-weight: 700;
        }

        .capitulo-row:hover {
            background: var(--tm01-primary) !important;
        }

        .subcapitulo-row {
            background: var(--border-light);
            font-weight: 600;
        }

        .item-row {
            background: white;
        }

        .item-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--tm01-primary);
        }

        .amount {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .loading {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="tm01-navbar">
        <div class="tm01-brand">
            üìä WBS Completa
            <span class="tm01-status-badge" style="margin-left: 10px;">T01</span>
        </div>
        <div class="tm01-nav-links">
            <a href="index.html" class="tm01-nav-link">üè† Inicio</a>
            <a href="dashboard_tecnico.html" class="tm01-nav-link">üìê Dashboard T√©cnico</a>
            <a href="presupuesto.html" class="tm01-nav-link">üí∞ Presupuesto</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="tm01-container">
        <!-- Header Card -->
        <div class="tm01-card">
            <div class="tm01-card-header">
                <h1 class="tm01-card-title">üìä Estructura de Desglose de Trabajo (WBS)</h1>
                <p class="tm01-card-subtitle">Fuente de Verdad: Ingenier√≠a de Detalle (T05) + Dict√°menes Jur√≠dicos</p>
            </div>

            <!-- Stats Grid -->
            <div class="tm01-stats-grid">
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üì¶</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalItems">-</div>
                        <div class="tm01-stat-label">Total Items WBS</div>
                    </div>
                </div>
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üíµ</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalUSD">-</div>
                        <div class="tm01-stat-label">CAPEX Total (USD)</div>
                    </div>
                </div>
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üí∞</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalCOP">-</div>
                        <div class="tm01-stat-label">CAPEX Total (COP)</div>
                    </div>
                </div>
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üîß</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalSistemas">-</div>
                        <div class="tm01-stat-label">Sistemas Activos</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WBS Table Card -->
        <div class="wbs-container">
            <table class="wbs-table">
                <thead>
                    <tr>
                        <th style="width: 100px">Item</th>
                        <th>Descripci√≥n</th>
                        <th style="width: 100px">Sistema</th>
                        <th style="width: 80px">Cant.</th>
                        <th style="width: 60px">Unid.</th>
                        <th style="width: 120px">VU (USD)</th>
                        <th style="width: 150px">VU (COP)</th>
                        <th style="width: 120px">Total (USD)</th>
                        <th style="width: 150px">Total (COP)</th>
                    </tr>
                </thead>
                <tbody id="wbsBody">
                    <tr>
                        <td colspan="9" class="loading">‚è≥ Cargando datos...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cargar datos -->
    <script src="datos_wbs_TM01_items.js"></script>

    <!-- Script simple para renderizar -->
    <script>
        // Esperar a que los datos est√©n cargados
        function init() {
            // Verificar que los datos existan
            if (typeof window.wbsDataGlobal === 'undefined' && typeof window.datos_wbs === 'undefined') {
                setTimeout(init, 50);
                return;
            }

            // Obtener los datos
            const data = window.wbsDataGlobal || window.datos_wbs;
            const items = data.items || [];

            console.log('‚úÖ Datos cargados:', items.length, 'items');

            // Renderizar tabla
            const tbody = document.getElementById('wbsBody');
            tbody.innerHTML = '';

            items.forEach(item => {
                const tr = document.createElement('tr');

                // Determinar clase seg√∫n tipo
                if (item.tipo === 'capitulo' || item.nivel === 1) {
                    tr.className = 'capitulo-row';
                } else if (item.tipo === 'subcapitulo' || item.nivel === 2) {
                    tr.className = 'subcapitulo-row';
                } else {
                    tr.className = 'item-row';
                }

                // Formatear valores
                const cantidad = item.cantidad || '';
                const unidad = item.unidad || '';
                const vu = item.vu || '';
                const vuCOP = item.vuCOP || '';
                const total = item.total || '';
                const totalCOP = item.totalCOP || '';

                tr.innerHTML = `
                    <td class="item-code">${item.item}</td>
                    <td>${item.descripcion}</td>
                    <td>${item.sistema || ''}</td>
                    <td class="amount">${cantidad}</td>
                    <td>${unidad}</td>
                    <td class="amount">${vu ? '$' + vu : ''}</td>
                    <td class="amount">${vuCOP ? '$' + vuCOP : ''}</td>
                    <td class="amount">${total ? '$' + total : ''}</td>
                    <td class="amount">${totalCOP ? '$' + totalCOP : ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Calcular estad√≠sticas
            const itemsReales = items.filter(i => i.tipo === 'item' || i.nivel === 3);
            const sistemas = [...new Set(items.map(i => i.sistema).filter(s => s))];

            const totalUSD = itemsReales.reduce((sum, item) => {
                const val = parseFloat(String(item.total || '0').replace(/,/g, ''));
                return sum + (isNaN(val) ? 0 : val);
            }, 0);

            const totalCOPVal = itemsReales.reduce((sum, item) => {
                const val = parseFloat(String(item.totalCOP || '0').replace(/,/g, ''));
                return sum + (isNaN(val) ? 0 : val);
            }, 0);

            // Actualizar estad√≠sticas
            document.getElementById('totalItems').textContent = itemsReales.length;
            document.getElementById('totalUSD').textContent = '$' + totalUSD.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('totalCOP').textContent = '$' + totalCOPVal.toLocaleString('en-US', { maximumFractionDigits: 0 });
            document.getElementById('totalSistemas').textContent = sistemas.length;

            console.log('‚úÖ WBS renderizada correctamente');
        }

        // Iniciar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>
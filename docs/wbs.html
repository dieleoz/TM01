<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Completa - TM01 Troncal Magdalena</title>
    <link rel="stylesheet" href="css/tm01-design-system.css">
    <style>
        body {
            padding: var(--space-lg);
            background: var(--bg-main);
        }

        .header {
            background: white;
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            box-shadow: var(--shadow-sm);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-top: var(--space-md);
        }

        .stat-card {
            background: var(--bg-light);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--tm01-primary);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--tm01-primary);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }

        .wbs-container {
            background: var(--bg-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow-x: auto;
            /* Habilitar scroll horizontal */
            margin-top: var(--space-xl);
            border: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
        }

        .wbs-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .wbs-table th {
            background: var(--bg-gradient-start);
            color: var(--text-inverse);
            padding: var(--space-md);
            text-align: left;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .wbs-table td {
            padding: var(--space-sm) var(--space-md);
            border-bottom: 1px solid var(--border-light);
            font-size: 0.9rem;
            transition: all var(--transition-fast);
        }

        /* JERARQU√çA WBS */
        .capitulo-row {
            background: #e0f2fe !important;
            color: var(--tm01-primary);
            font-weight: 800;
            font-size: 1rem;
            border-left: 6px solid var(--tm01-accent);
        }

        .subcapitulo-row {
            background: #f8fafc !important;
            font-weight: 700;
            color: var(--text-main);
            border-left: 6px solid var(--text-muted);
        }

        .item-row {
            background: white;
        }

        .item-row:hover {
            background: var(--bg-hover) !important;
            transform: translateX(4px);
        }

        /* INDENTACI√ìN */
        .indent-1 {
            padding-left: var(--space-md) !important;
        }

        .indent-2 {
            padding-left: var(--space-2xl) !important;
        }

        .indent-3 {
            padding-left: calc(var(--space-2xl) * 1.5) !important;
        }

        .item-code {
            font-family: 'Fira Code', 'Courier New', monospace;
            font-weight: 700;
            color: var(--tm01-accent);
        }

        .amount {
            text-align: right;
            font-family: 'Fira Code', monospace;
        }

        .currency-symbol {
            color: var(--text-muted);
            font-size: 0.8em;
            margin-right: 2px;
        }

        .system-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 700;
            background: var(--info-bg);
            color: var(--tm01-accent);
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="tm01-navbar">
        <div class="tm01-brand">
            üìä WBS Completa
            <span class="tm01-status-badge" style="margin-left: 10px;">T01</span>
        </div>
        <div class="tm01-nav-links">
            <a href="WBS_Menu_Principal.html" class="tm01-nav-link">üè† Men√∫ Principal</a>
            <a href="dashboard_tecnico.html" class="tm01-nav-link">üìê Dashboard T√©cnico</a>
            <a href="presupuesto.html" class="tm01-nav-link">üí∞ Presupuesto</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="tm01-container" style="max-width: 1500px;"> <!-- Ampliado para visualizaci√≥n completa de columnas -->
        <!-- Header Card -->
        <div class="tm01-card">
            <div class="tm01-card-header">
                <h1 class="tm01-card-title">üìä Estructura de Desglose de Trabajo (WBS)</h1>
                <p class="tm01-card-subtitle">Fuente de Verdad: Ingenier√≠a de Detalle (T05) + Dict√°menes Jur√≠dicos</p>
            </div>

            <!-- Stats Grid -->
            <div class="tm01-stats-grid">
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üì¶</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalItems">-</div>
                        <div class="tm01-stat-label">Total Items WBS</div>
                    </div>
                </div>
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üíµ</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalUSD">-</div>
                        <div class="tm01-stat-label">CAPEX Total (USD)</div>
                    </div>
                </div>
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üí∞</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalCOP">-</div>
                        <div class="tm01-stat-label">CAPEX Total (COP)</div>
                    </div>
                </div>
                <div class="tm01-stat-card">
                    <div class="tm01-stat-icon">üîß</div>
                    <div class="tm01-stat-content">
                        <div class="tm01-stat-value" id="totalSistemas">-</div>
                        <div class="tm01-stat-label">Sistemas Activos</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WBS Table Card -->
        <div class="wbs-container">
            <table class="wbs-table">
                <thead>
                    <tr>
                        <th style="width: 100px">Item</th>
                        <th>Descripci√≥n</th>
                        <th style="width: 100px">Sistema</th>
                        <th style="width: 80px">Cant.</th>
                        <th style="width: 60px">Unid.</th>
                        <th style="width: 120px" class="amount">V.U. (USD)</th>
                        <th style="width: 150px" class="amount">V.U. (COP)</th>
                        <th style="width: 125px" class="amount">TOTAL (USD)</th>
                        <th style="width: 155px" class="amount">TOTAL (COP)</th>
                    </tr>
                </thead>
                <tbody id="wbsBody">
                    <tr>
                        <td colspan="9" class="loading">‚è≥ Cargando datos...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cargar datos -->
    <script src="datos_wbs_TM01_items.js"></script>

    <!-- Script simple para renderizar -->
    <script>
        // Esperar a que los datos est√©n cargados
        function init() {
            // Verificar que los datos existan
            if (typeof window.wbsDataGlobal === 'undefined' && typeof window.datos_wbs === 'undefined') {
                setTimeout(init, 50);
                return;
            }

            // Obtener los datos
            const data = window.wbsDataGlobal || window.datos_wbs;
            const items = data.items || [];

            console.log('‚úÖ Datos cargados:', items.length, 'items');

            // Renderizar tabla
            const tbody = document.getElementById('wbsBody');
            tbody.innerHTML = '';

            items.forEach(item => {
                const tr = document.createElement('tr');
                const lvl = item.nivel || 3;

                // Determinar clase seg√∫n tipo y nivel profesional
                if (item.tipo === 'capitulo' || lvl === 1) {
                    tr.className = 'capitulo-row';
                } else if (item.tipo === 'subcapitulo' || lvl === 2) {
                    tr.className = 'subcapitulo-row';
                } else {
                    tr.className = 'item-row';
                }

                // Formatear valores - Mapeo de campos Audit 6.0
                const cantidad = item.cantidad || '';
                const unidad = item.unidad || '';
                const totalUSD_Val = item.totalUSD || item.total || '';
                const totalCOP_Val = item.totalCOP || '';

                // C√°lculo din√°mico de VU si falta en la fuente
                let vuUSD = item.vu || '';
                let vuCOP = item.vuCOP || '';
                if (!vuUSD && totalUSD_Val && cantidad && !isNaN(parseFloat(cantidad)) && parseFloat(cantidad) > 0) {
                    vuUSD = (parseFloat(String(totalUSD_Val).replace(/,/g, '')) / parseFloat(cantidad)).toFixed(2);
                }
                if (!vuCOP && totalCOP_Val && cantidad && !isNaN(parseFloat(cantidad)) && parseFloat(cantidad) > 0) {
                    vuCOP = Math.round(parseFloat(String(totalCOP_Val).replace(/,/g, '')) / parseFloat(cantidad));
                }

                // Aplicar Indentaci√≥n Visual por Nivel (UX Standard)
                const indentClass = `indent-${lvl}`;

                tr.innerHTML = `
                    <td class="item-code ${indentClass}">${item.item}</td>
                    <td style="font-weight:${lvl < 3 ? 'bold' : 'normal'}">${item.descripcion}</td>
                    <td><span class="system-tag">${item.sistema || ''}</span></td>
                    <td class="amount">${cantidad}</td>
                    <td style="text-align:center; color:var(--text-sub); font-size:0.8rem;">${unidad}</td>
                    <td class="amount"><span class="currency-symbol">$</span>${vuUSD ? parseFloat(vuUSD).toLocaleString('en-US') : ''}</td>
                    <td class="amount"><span class="currency-symbol">$</span>${vuCOP ? parseInt(vuCOP).toLocaleString('es-CO') : ''}</td>
                    <td class="amount" style="font-weight:bold;"><span class="currency-symbol">$</span>${totalUSD_Val ? parseFloat(String(totalUSD_Val).replace(/,/g, '')).toLocaleString('en-US') : ''}</td>
                    <td class="amount" style="font-weight:bold; background: rgba(16, 185, 129, 0.05);"><span class="currency-symbol">$</span>${totalCOP_Val ? parseFloat(String(totalCOP_Val).replace(/,/g, '')).toLocaleString('es-CO') : ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Calcular estad√≠sticas
            const itemsReales = items.filter(i => i.tipo === 'item' || i.nivel === 3);
            const sistemas = [...new Set(items.map(i => i.sistema).filter(s => s))];

            const totalUSD = itemsReales.reduce((sum, item) => {
                const val = parseFloat(String(item.total || '0').replace(/,/g, ''));
                return sum + (isNaN(val) ? 0 : val);
            }, 0);

            const totalCOPVal = itemsReales.reduce((sum, item) => {
                const val = parseFloat(String(item.totalCOP || '0').replace(/,/g, ''));
                return sum + (isNaN(val) ? 0 : val);
            }, 0);

            // Actualizar estad√≠sticas
            document.getElementById('totalItems').textContent = itemsReales.length;
            document.getElementById('totalUSD').textContent = '$' + totalUSD.toLocaleString('en-US', { maximumFractionDigits: 2 });
            document.getElementById('totalCOP').textContent = '$' + totalCOPVal.toLocaleString('en-US', { maximumFractionDigits: 0 });
            document.getElementById('totalSistemas').textContent = sistemas.length;

            console.log('‚úÖ WBS renderizada correctamente');
        }

        // Iniciar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>
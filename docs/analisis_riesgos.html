<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>An√°lisis de Riesgos - TM01 Troncal Magdalena</title>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Estilos -->
  <link rel="stylesheet" href="css/tm01-design-system.css">
  <style>
    /* Estilos espec√≠ficos Riesgos */
    .risk-matrix-container {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 4px;
      margin-top: 15px;
    }

    .matrix-cell {
      padding: 8px;
      border-radius: var(--radius-sm);
      font-size: 0.8em;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: var(--bg-surface);
      border: 1px solid var(--border);
      transition: all var(--transition-fast);
    }

    .matrix-cell:hover {
      transform: scale(1.02);
      z-index: 10;
      box-shadow: var(--shadow-md);
    }

    .matrix-header {
      background-color: var(--tm01-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      text-align: center;
      font-size: 0.8em;
      border-radius: var(--radius-sm);
    }

    /* Zonas de Riesgo */
    .zone-red {
      background-color: #fee2e2;
      border-color: #fca5a5;
    }

    .zone-yellow {
      background-color: #fef9c3;
      border-color: #fde047;
    }

    .zone-green {
      background-color: #dcfce7;
      border-color: #86efac;
    }

    .risk-tag {
      background: rgba(255, 255, 255, 0.9);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.85em;
      cursor: help;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 3px solid var(--tm01-primary);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .severity-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 0.75em;
      font-weight: 700;
    }

    .sev-high {
      background: var(--error);
      color: white;
    }

    .sev-med {
      background: var(--warning);
      color: white;
    }

    .sev-low {
      background: var(--success);
      color: white;
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="tm01-navbar">
    <div class="tm01-brand">
      <span style="margin-right: 8px;">üõ°Ô∏è</span>
      Gesti√≥n de Riesgos TM01
      <span class="tm01-status-badge" style="margin-left: 10px;">ISO 31000</span>
    </div>
    <div style="display: flex; gap: 10px;">
      <a href="WBS_Menu_Principal.html" class="tm01-btn tm01-btn-link">‚Üê Volver al Men√∫</a>
      <button class="tm01-btn tm01-btn-primary" onclick="exportarExcel()">üìä Exportar Excel</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="tm01-container" style="padding-top: var(--space-xl);">

    <!-- Header -->
    <div style="margin-bottom: var(--space-lg); display: flex; justify-content: space-between; align-items: end;">
      <div>
        <h1 style="color: var(--tm01-primary); margin-bottom: 5px;">Matriz de Riesgos y Oportunidades</h1>
        <p style="color: var(--text-sub);">An√°lisis Consecuencia vs Probabilidad (Audit 6.0 Verified)</p>
      </div>
      <div>
        <button class="tm01-btn" onclick="window.print()">üñ®Ô∏è Imprimir Reporte</button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="tm01-grid-4" style="margin-bottom: var(--space-xl);">
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mTotal">-</div>
        <div class="tm01-stat-label">Total Riesgos</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mAltos" style="color: var(--error);">-</div>
        <div class="tm01-stat-label">Severidad Alta</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mMedios" style="color: var(--warning);">-</div>
        <div class="tm01-stat-label">Severidad Media</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mBajos" style="color: var(--success);">-</div>
        <div class="tm01-stat-label">Severidad Baja</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="tm01-card" style="margin-bottom: var(--space-lg);">
      <div style="display: flex; gap: var(--space-md); flex-wrap: wrap; align-items: end;">
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.9em;">Severidad</label>
          <select id="fSeveridad" onchange="aplicarFiltros()" class="tm01-btn"
            style="width: 100%; background: white; border-color: var(--border);">
            <option value="">Todas</option>
            <option>ALTO</option>
            <option>MEDIO</option>
            <option>BAJO</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.9em;">Categor√≠a</label>
          <select id="fCategoria" onchange="aplicarFiltros()" class="tm01-btn"
            style="width: 100%; background: white; border-color: var(--border);">
            <option value="">Todas</option>
          </select>
        </div>
        <div style="flex: 2;">
          <label style="display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.9em;">B√∫squeda</label>
          <input id="fBuscar" placeholder="Buscar riesgo..." oninput="aplicarFiltros()" class="tm01-btn"
            style="width: 100%; background: white; border-color: var(--border); cursor: text;" />
        </div>
      </div>
    </div>

    <!-- Heatmap -->
    <div class="tm01-section">
      <div class="tm01-section-header">üìä Mapa de Calor (Heatmap)</div>
      <div class="tm01-section-content">
        <div id="matrix" style="overflow-x: auto;"></div>
      </div>
    </div>

    <!-- Detail Table -->
    <div class="tm01-section">
      <div class="tm01-section-header">üìã Detalle de Riesgos</div>
      <div class="tm01-section-content" style="padding: 0;">
        <table class="tm01-table" id="tabla">
          <thead>
            <tr>
              <th>Riesgo</th>
              <th>Categor√≠a</th>
              <th style="text-align: center;">Severidad</th>
              <th style="text-align: center;">Prob.</th>
              <th style="text-align: center;">Imp.</th>
              <th>Plan de Mitigaci√≥n</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">Cargando datos...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div style="margin: var(--space-2xl) 0; color: var(--text-muted); font-size: 0.8em; text-align: center;">
      <p><strong>TM01 Troncal Magdalena</strong> - Sistema de Gesti√≥n de Riesgos</p>
      <p>Datos actualizados: <span id="lastUpdate">--</span></p>
    </div>

  </div>

  <!-- Scripts -->
  <script src="data/tm01_master_data.js?v=20260130"></script>
  <script src="data/tm01_riesgos_data.js?v=20260130"></script>

  <script>
    // Inline JS Logic adapted for new DOM
    let all = [], filtered = [];

    function severidad(prob, imp) {
      const s = prob * imp;
      if (s >= 15) return 'ALTO';
      if (s >= 8) return 'MEDIO';
      return 'BAJO';
    }

    function init() {
      if (typeof window.TM01_RIESGOS_DATA === 'undefined') {
        setTimeout(init, 100);
        return;
      }

      const data = window.TM01_RIESGOS_DATA;

      // Map data
      all = data.riesgos.map(r => ({
        ...r,
        sev: severidad(r.prob, r.imp)
      }));
      filtered = [...all];

      // Render
      poblarFiltros();
      renderMatriz();
      renderTabla();
      actualizarMetricas();

      document.getElementById('lastUpdate').textContent = data.fechaActualizacion || 'Hoy';
    }

    function poblarFiltros() {
      const cat = [...new Set(all.map(r => r.categoria))];
      const s = document.getElementById('fCategoria');
      // Keep default option
      s.innerHTML = '<option value="">Todas</option>';
      cat.forEach(c => {
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        s.appendChild(o);
      });
    }

    function aplicarFiltros() {
      const sev = document.getElementById('fSeveridad').value;
      const cat = document.getElementById('fCategoria').value;
      const q = (document.getElementById('fBuscar').value || '').toLowerCase();

      filtered = all.filter(r => {
        if (sev && r.sev !== sev) return false;
        if (cat && r.categoria !== cat) return false;
        if (q && !(r.titulo || '').toLowerCase().includes(q)) return false;
        return true;
      });

      renderMatriz();
      renderTabla();
      actualizarMetricas();
    }

    function renderMatriz() {
      const cont = document.getElementById('matrix');
      const labels = ['Muy Bajo', 'Bajo', 'Medio', 'Alto', 'Muy Alto'];

      // Initialize Grid 5x5
      const grid = [];
      for (let i = 0; i < 5; i++) { grid[i] = []; for (let j = 0; j < 5; j++) { grid[i][j] = []; } }

      filtered.forEach(r => {
        const p = Math.max(1, Math.min(5, r.prob)) - 1;
        const im = Math.max(1, Math.min(5, r.imp)) - 1;
        grid[p][im].push(r);
      });

      let html = '<div class="risk-matrix-container">';

      // Header X
      html += '<div class="matrix-header">Prob/Imp</div>';
      labels.forEach(l => html += `<div class="matrix-header" style="background:var(--border-dark);color:var(--text-main);">${l}</div>`);

      // Rows (Prob desc 5->1)
      for (let p = 4; p >= 0; p--) {
        html += `<div class="matrix-header" style="background:var(--border-dark);color:var(--text-main);">Prob ${p + 1}</div>`;
        for (let im = 0; im < 5; im++) {
          const cel = grid[p][im];
          const score = (p + 1) * (im + 1);
          let zoneClass = score >= 15 ? 'zone-red' : (score >= 8 ? 'zone-yellow' : 'zone-green');

          html += `<div class="matrix-cell ${zoneClass}">` +
            cel.map(x => `<div class="risk-tag" title="${x.mitigacion}">${x.id}</div>`).join('') +
            `</div>`;
        }
      }
      html += '</div>';
      cont.innerHTML = html;
    }

    function renderTabla() {
      const tb = document.querySelector('#tabla tbody');
      if (filtered.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted);">No se encontraron riesgos</td></tr>';
        return;
      }

      tb.innerHTML = filtered.map(r => {
        let badgeClass = r.sev === 'ALTO' ? 'sev-high' : (r.sev === 'MEDIO' ? 'sev-med' : 'sev-low');

        return `<tr>
                    <td>
                        <strong style="color:var(--tm01-primary);">${r.titulo}</strong><br>
                        <span style="font-size:0.85em; color:var(--text-muted);">${r.id}</span>
                    </td>
                    <td>${r.categoria}</td>
                    <td style="text-align:center"><span class="severity-badge ${badgeClass}">${r.sev}</span></td>
                    <td style="text-align:center">${r.prob}</td>
                    <td style="text-align:center">${r.imp}</td>
                    <td style="font-size:0.9em;">${r.mitigacion}</td>
                </tr>`;
      }).join('');
    }

    function actualizarMetricas() {
      document.getElementById('mTotal').textContent = all.length;
      document.getElementById('mAltos').textContent = all.filter(r => r.sev === 'ALTO').length;
      document.getElementById('mMedios').textContent = all.filter(r => r.sev === 'MEDIO').length;
      document.getElementById('mBajos').textContent = all.filter(r => r.sev === 'BAJO').length;
    }

    function exportarExcel() {
      if (filtered.length === 0) return alert('No hay datos');
      const rows = filtered.map(r => ({
        ID: r.id, Riesgo: r.titulo, Categoria: r.categoria, Severidad: r.sev,
        Prob: r.prob, Imp: r.imp, Score: r.prob * r.imp, Mitigacion: r.mitigacion
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Riesgos');
      XLSX.writeFile(wb, 'Riesgos_TM01.xlsx');
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>An√°lisis de Riesgos - TM01 Troncal Magdalena</title>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Estilos -->
  <link rel="stylesheet" href="css/tm01-design-system.css">
  <style>
    /* Estilos espec√≠ficos Riesgos */
    .risk-matrix-container {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 4px;
      margin-top: 15px;
    }

    .matrix-cell {
      padding: 10px;
      border-radius: 6px;
      font-size: 0.85em;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.05);
    }

    .matrix-header {
      background-color: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      text-align: center;
      font-size: 0.8em;
      border-radius: 4px;
    }

    .zone-red {
      background-color: #fee2e2;
      border: 1px solid #ef4444;
    }

    .zone-yellow {
      background-color: #fefce8;
      border: 1px solid #eab308;
    }

    .zone-green {
      background-color: #dcfce7;
      border: 1px solid #22c55e;
    }

    .risk-tag {
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
      cursor: help;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 3px solid var(--primary);
    }

    .risk-badge-high {
      background-color: #ef4444;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 0.8em;
    }

    .risk-badge-med {
      background-color: #eab308;
      color: black;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 0.8em;
    }

    .risk-badge-low {
      background-color: #22c55e;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 0.8em;
    }
  </style>
</head>

<body class="bg-gray-50">

  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-brand">
        <span class="brand-icon">üõ°Ô∏è</span>
        <span class="brand-text">Gesti√≥n de Riesgos TM01</span>
      </div>
      <div class="nav-menu">
        <a href="WBS_Menu_Principal.html" class="nav-link">‚Üê Volver al Men√∫</a>
        <span class="badge badge-warning">Active Monitoring</span>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container main-content">

    <!-- Header -->
    <header class="page-header">
      <div class="header-content">
        <h1>Matriz de Riesgos y Oportunidades</h1>
        <p>An√°lisis Consecuencia vs Probabilidad (ISO 31000)</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-primary" onclick="exportarExcel()">üìä Exportar Excel</button>
      </div>
    </header>

    <!-- KPI Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìâ</div>
        <div class="stat-info">
          <h3>Total Riesgos</h3>
          <p class="stat-value" id="mTotal">-</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color: #ef4444;">üî¥</div>
        <div class="stat-info">
          <h3>Severidad Alta</h3>
          <p class="stat-value" id="mAltos">-</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color: #eab308;">üü°</div>
        <div class="stat-info">
          <h3>Severidad Media</h3>
          <p class="stat-value" id="mMedios">-</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="color: #22c55e;">üü¢</div>
        <div class="stat-info">
          <h3>Severidad Baja</h3>
          <p class="stat-value" id="mBajos">-</p>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card p-4 mb-4">
      <div class="filter-group" style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
        <div style="flex: 1;">
          <label class="form-label">Severidad</label>
          <select id="fSeveridad" onchange="aplicarFiltros()" class="form-control">
            <option value="">Todas</option>
            <option>ALTO</option>
            <option>MEDIO</option>
            <option>BAJO</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label class="form-label">Categor√≠a</label>
          <select id="fCategoria" onchange="aplicarFiltros()" class="form-control">
            <option value="">Todas</option>
          </select>
        </div>
        <div style="flex: 2;">
          <label class="form-label">B√∫squeda</label>
          <input id="fBuscar" placeholder="Buscar riesgo..." oninput="aplicarFiltros()" class="form-control" />
        </div>
      </div>
    </div>

    <!-- Matrix Visualization -->
    <div class="card p-4 mb-4">
      <h3 class="card-title">üìä Mapa de Calor (Heatmap)</h3>
      <div id="matrix" style="overflow-x: auto;"></div>
    </div>

    <!-- Detailed List -->
    <div class="card p-4">
      <h3 class="card-title">üìã Detalle de Riesgos</h3>
      <table class="table" id="tabla">
        <thead>
          <tr>
            <th>Riesgo</th>
            <th>Categor√≠a</th>
            <th>Severidad</th>
            <th>Probabilidad</th>
            <th>Impacto</th>
            <th>Plan de Mitigaci√≥n</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="6" class="text-center text-muted">Cargando datos...</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p><strong>TM01 Troncal Magdalena</strong> - Sistema de Gesti√≥n de Riesgos</p>
      <p>Metodolog√≠a: PMI / ISO 31000</p>
      <p id="lastUpdate">Actualizado: --</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="data/tm01_master_data.js?v=20260130"></script>
  <script src="data/tm01_riesgos_data.js?v=20260130"></script>

  <script>
    // Inline JS migrating logic from old file but adapting to new DOM
    let all = [], filtered = [];

    function severidad(prob, imp) {
      const s = prob * imp;
      if (s >= 15) return 'ALTO';
      if (s >= 8) return 'MEDIO';
      return 'BAJO';
    }

    function init() {
      if (typeof window.TM01_RIESGOS_DATA === 'undefined') {
        setTimeout(init, 100);
        return;
      }

      const data = window.TM01_RIESGOS_DATA;

      // Map data
      all = data.riesgos.map(r => ({
        ...r,
        sev: severidad(r.prob, r.imp)
      }));
      filtered = [...all];

      // Render
      poblarFiltros();
      renderMatriz();
      renderTabla();
      actualizarMetricas();

      document.getElementById('lastUpdate').textContent = `Actualizado: ${data.fechaActualizacion || 'Hoy'}`;
    }

    function poblarFiltros() {
      const cat = [...new Set(all.map(r => r.categoria))];
      const s = document.getElementById('fCategoria');
      s.innerHTML = '<option value="">Todas</option>';
      cat.forEach(c => {
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        s.appendChild(o);
      });
    }

    function aplicarFiltros() {
      const sev = document.getElementById('fSeveridad').value;
      const cat = document.getElementById('fCategoria').value;
      const q = (document.getElementById('fBuscar').value || '').toLowerCase();

      filtered = all.filter(r => {
        if (sev && r.sev !== sev) return false;
        if (cat && r.categoria !== cat) return false;
        if (q && !(r.titulo || '').toLowerCase().includes(q)) return false;
        return true;
      });

      renderMatriz();
      renderTabla();
      actualizarMetricas();
    }

    function renderMatriz() {
      const cont = document.getElementById('matrix');
      const labels = ['Muy Bajo', 'Bajo', 'Medio', 'Alto', 'Muy Alto'];

      // Initialize Grid 5x5
      const grid = [];
      for (let i = 0; i < 5; i++) { grid[i] = []; for (let j = 0; j < 5; j++) { grid[i][j] = []; } }

      filtered.forEach(r => {
        const p = Math.max(1, Math.min(5, r.prob)) - 1;
        const im = Math.max(1, Math.min(5, r.imp)) - 1;
        grid[p][im].push(r);
      });

      let html = '<div class="risk-matrix-container">';

      // Header X
      html += '<div class="matrix-header">Prob/Imp</div>';
      labels.forEach(l => html += `<div class="matrix-header">${l}</div>`);

      // Rows (Prob desc 5->1)
      for (let p = 4; p >= 0; p--) {
        html += `<div class="matrix-header">Prob ${p + 1}</div>`;
        for (let im = 0; im < 5; im++) {
          const cel = grid[p][im];
          const score = (p + 1) * (im + 1);
          let zoneClass = score >= 15 ? 'zone-red' : (score >= 8 ? 'zone-yellow' : 'zone-green');

          html += `<div class="matrix-cell ${zoneClass}">` +
            cel.map(x => `<div class="risk-tag" title="${x.mitigacion}">${x.id}</div>`).join('') +
            `</div>`;
        }
      }
      html += '</div>';
      cont.innerHTML = html;
    }

    function renderTabla() {
      const tb = document.querySelector('#tabla tbody');
      if (filtered.length === 0) {
        tb.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No se encontraron riesgos</td></tr>';
        return;
      }

      tb.innerHTML = filtered.map(r => {
        const badgeClass = r.sev === 'ALTO' ? 'risk-badge-high' : (r.sev === 'MEDIO' ? 'risk-badge-med' : 'risk-badge-low');

        return `<tr>
                    <td>
                        <strong>${r.titulo}</strong><br>
                        <span class="text-muted small">${r.id}</span>
                    </td>
                    <td>${r.categoria}</td>
                    <td><span class="${badgeClass}">${r.sev}</span></td>
                    <td class="text-center">${r.prob}</td>
                    <td class="text-center">${r.imp}</td>
                    <td>${r.mitigacion}</td>
                </tr>`;
      }).join('');
    }

    function actualizarMetricas() {
      document.getElementById('mTotal').textContent = all.length;
      document.getElementById('mAltos').textContent = all.filter(r => r.sev === 'ALTO').length;
      document.getElementById('mMedios').textContent = all.filter(r => r.sev === 'MEDIO').length;
      document.getElementById('mBajos').textContent = all.filter(r => r.sev === 'BAJO').length;
    }

    function exportarExcel() {
      if (filtered.length === 0) return alert('No hay datos');
      const rows = filtered.map(r => ({
        ID: r.id, Riesgo: r.titulo, Categoria: r.categoria, Severidad: r.sev,
        Prob: r.prob, Imp: r.imp, Score: r.prob * r.imp, Mitigacion: r.mitigacion
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Riesgos');
      XLSX.writeFile(wb, 'Riesgos_TM01.xlsx');
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
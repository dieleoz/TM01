<!DOCTYPE html>
<html lang="es">

<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cronograma Maestro - TM01 Troncal Magdalena</title>

  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="css/tm01-design-system.css">

  <style>
    .gantt-container {
      display: flex;
      width: 100%;
      height: 24px;
      background: var(--bg-hover);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
    }

    .gantt-spacer {
      flex-grow: 0;
      flex-shrink: 0;
    }

    .gantt-bar {
      flex-grow: 1;
      background: var(--tm01-accent);
      border-radius: 4px;
      min-width: 4px;
    }

    .gantt-bar.milestone {
      background: var(--warning);
      width: 12px;
      flex-grow: 0;
      border-radius: 50%;
      margin-left: -6px;
      /* center on date */
    }

    .filters-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters-grid select,
    .filters-grid input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      min-width: 200px;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="tm01-navbar">
    <div class="tm01-brand">
      üìÖ Cronograma Maestro <span class="tm01-status-badge">TM01</span>
    </div>
    <div style="display:flex; gap:10px;">
      <a href="WBS_Menu_Principal.html" class="tm01-btn tm01-btn-link">‚Üê Men√∫</a>
      <button class="tm01-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
      <button class="tm01-btn tm01-btn-success" onclick="exportarExcel()">üìä Excel</button>
    </div>
  </nav>

  <div class="tm01-container" style="padding-top: var(--space-xl);">

    <!-- Metrics -->
    <div class="tm01-grid-4" style="margin-bottom: var(--space-lg);">
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mDuracion">-</div>
        <div class="tm01-stat-label">Duraci√≥n (meses)</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mHitos">-</div>
        <div class="tm01-stat-label">Hitos Cr√≠ticos</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mFases">-</div>
        <div class="tm01-stat-label">Fases Activas</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mInicioFin" style="font-size: 1.1rem;">-</div>
        <div class="tm01-stat-label">Rango Global</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="tm01-section">
      <div class="tm01-section-header">üîç Filtros de Visualizaci√≥n</div>
      <div class="tm01-section-content">
        <div class="filters-grid">
          <select id="fFase" onchange="aplicarFiltros()">
            <option value="">Todas las fases</option>
          </select>
          <select id="fSistema" onchange="aplicarFiltros()">
            <option value="">Todos los sistemas</option>
          </select>
          <input id="fBuscar" placeholder="Buscar tarea..." oninput="aplicarFiltros()" />
        </div>
      </div>
    </div>

    <!-- Gantt Table -->
    <div class="tm01-section">
      <div class="tm01-section-header">üìä Plan de Obra No Objetado (Hard Deck)</div>
      <div class="tm01-section-content">
        <div style="overflow-x: auto;">
          <table class="tm01-table" id="tabla">
            <thead>
              <tr>
                <th>Fase</th>
                <th>Actividad / Hito</th>
                <th>Sistema</th>
                <th>Inicio</th>
                <th>Fin</th>
                <th style="text-align: right;">Meses</th>
                <th style="width: 300px;">Visualizaci√≥n (Gantt)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" style="padding: 20px; text-align:center;">Cargando Cronograma Master...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-muted); display:flex; gap: 15px;">
          <div style="display:flex; align-items:center; gap:5px;"><span
              style="width:12px; height:12px; background:var(--tm01-accent); border-radius:3px;"></span> Actividad</div>
          <div style="display:flex; align-items:center; gap:5px;"><span
              style="width:12px; height:12px; background:var(--warning); border-radius:50%;"></span> Hito</div>
        </div>
      </div>
    </div>

  </div>

  <script src="data/tm01_master_data.js?v=20260128"></script>
  <script>
    const MS_DAY = 86400000;

    let allTasks = [];
    let filtered = [];

    function parseDate(s) {
      if (!s) return null;
      // Handle YYYY-MM-DD
      const parts = s.split('-');
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function fmt(d) {
      if (!d) return '-';
      return d.toLocaleDateString('es-CO', { year: '2-digit', month: 'short', day: 'numeric' });
    }

    function diffMonths(start, end) {
      if (!start || !end) return 0;
      return ((end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + (end.getDate() - start.getDate()) / 30).toFixed(1);
    }

    function init() {
      if (!window.tm01MasterData) { setTimeout(init, 200); return; }

      // Cargar desde Master Data (Source of Truth)
      const md = window.tm01MasterData.data;
      allTasks = (md.cronograma || []).map(t => ({
        ...t,
        dInicio: parseDate(t.inicio),
        dFin: parseDate(t.fin)
      })).sort((a, b) => a.dInicio - b.dInicio);

      if (allTasks.length === 0) {
        // Fallback si no hay datos
        console.warn("No cronograma in Master Data");
      }

      poblarFiltros();
      aplicarFiltros();
    }

    function poblarFiltros() {
      const fases = [...new Set(allTasks.map(t => t.fase))];
      const sistemas = [...new Set(allTasks.map(t => t.sistema))];

      const selF = document.getElementById('fFase');
      const selS = document.getElementById('fSistema');

      fases.forEach(f => {
        if (f) { const o = document.createElement('option'); o.value = f; o.textContent = f; selF.appendChild(o); }
      });
      sistemas.forEach(s => {
        if (s) { const o = document.createElement('option'); o.value = s; o.textContent = s; selS.appendChild(o); }
      });
    }

    function aplicarFiltros() {
      const fF = document.getElementById('fFase').value;
      const fS = document.getElementById('fSistema').value;
      const q = document.getElementById('fBuscar').value.toLowerCase();

      filtered = allTasks.filter(t => {
        if (fF && t.fase !== fF) return false;
        if (fS && t.sistema !== fS) return false;
        if (q && !t.nombre.toLowerCase().includes(q)) return false;
        return true;
      });

      calculateMetrics();
      renderTable();
    }

    function calculateMetrics() {
      if (filtered.length === 0) return;

      const minDate = new Date(Math.min(...filtered.map(t => t.dInicio).filter(d => d)));
      const maxDate = new Date(Math.max(...filtered.map(t => t.dFin).filter(d => d)));

      document.getElementById('mDuracion').textContent = diffMonths(minDate, maxDate);
      document.getElementById('mHitos').textContent = filtered.filter(t => t.hito).length;
      document.getElementById('mFases').textContent = [...new Set(filtered.map(t => t.fase))].size;
      document.getElementById('mInicioFin').innerText = `${fmt(minDate)} \n‚Üí ${fmt(maxDate)}`;

      window._minGlobal = minDate;
      window._maxGlobal = maxDate;
      window._spanGlobal = maxDate - minDate;
    }

    function renderTable() {
      const tb = document.querySelector('#tabla tbody');
      if (filtered.length === 0) { tb.innerHTML = '<tr><td colspan="7">Sin resultados</td></tr>'; return; }

      const minT = window._minGlobal ? window._minGlobal.getTime() : 0;
      const spanT = window._spanGlobal || 1;

      tb.innerHTML = filtered.map(t => {
        const ini = t.dInicio ? t.dInicio.getTime() : minT;
        const fin = t.dFin ? t.dFin.getTime() : ini;

        const offsetPct = ((ini - minT) / spanT) * 100;
        const widthPct = Math.max(((fin - ini) / spanT) * 100, 1); // Min 1% width

        let barHtml = '';
        if (t.hito) {
          barHtml = `<div class="gantt-container" style="background:transparent;"><div style="width:${offsetPct}%"></div><div class="gantt-bar milestone"></div></div>`;
        } else {
          barHtml = `<div class="gantt-container"><div class="gantt-spacer" style="width:${offsetPct}%"></div><div class="gantt-bar" style="width:${widthPct}%"></div></div>`;
        }

        return `
            <tr>
                <td><span class="tm01-status-badge" style="background:#f1f5f9; color:#475569;">${t.fase}</span></td>
                <td>
                    <strong>${t.nombre}</strong>
                    ${t.nota ? `<br><small style="color:var(--text-muted)">${t.nota}</small>` : ''}
                </td>
                <td><b>${t.sistema || '-'}</b></td>
                <td style="font-size:0.85rem;">${fmt(t.dInicio)}</td>
                <td style="font-size:0.85rem;">${fmt(t.dFin)}</td>
                <td style="text-align:right;">${t.hito ? 'HITO' : diffMonths(t.dInicio, t.dFin)}</td>
                <td>${barHtml}</td>
            </tr>
            `;
      }).join('');
    }

    function exportarExcel() {
      const rows = filtered.map(t => ({
        Fase: t.fase,
        Actividad: t.nombre,
        Sistema: t.sistema,
        Inicio: fmt(t.dInicio),
        Fin: fmt(t.dFin),
        Notas: t.nota || ''
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cronograma");
      XLSX.writeFile(wb, "Cronograma_TM01_HardDeck.xlsx");
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
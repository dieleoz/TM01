<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cronograma Construcci√≥n - TM01 Troncal Magdalena</title>

  <!-- Librer√≠as -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Estilos -->
  <link rel="stylesheet" href="css/tm01-design-system.css">
  <style>
    /* Personalizaci√≥n Gantt compatible con Design System */
    .gantt-wrapper {
      display: flex;
      align-items: center;
      width: 100%;
      height: 28px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      overflow: hidden;
      position: relative;
    }

    .gantt-bar {
      height: 100%;
      background: var(--tm01-accent);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.7em;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      min-width: 4px;
    }

    .gantt-milestone {
      width: 16px;
      height: 16px;
      background: var(--warning);
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: var(--shadow-sm);
      margin-left: -8px;
      /* Center */
      z-index: 2;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: 0.75em;
      font-weight: 700;
      background: var(--bg-hover);
      color: var(--text-sub);
    }

    .status-pill.construction {
      background: var(--info-bg);
      color: var(--info);
    }

    .status-pill.pre {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .status-pill.transversal {
      background: var(--success-bg);
      color: var(--success);
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="tm01-navbar">
    <div class="tm01-brand">
      <span style="margin-right: 8px;">üìÖ</span>
      Cronograma Maestro
      <span class="tm01-status-badge" style="margin-left: 10px;">Interventor√≠a Conciliada</span>
    </div>
    <div style="display: flex; gap: 10px;">
      <a href="WBS_Menu_Principal.html" class="tm01-btn tm01-btn-link">‚Üê Volver al Men√∫</a>
      <button class="tm01-btn tm01-btn-primary" onclick="exportarExcel()">üìä Exportar Excel</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="tm01-container" style="padding-top: var(--space-xl);">

    <!-- Header -->
    <div style="margin-bottom: var(--space-lg); display: flex; justify-content: space-between; align-items: end;">
      <div>
        <h1 style="color: var(--tm01-primary); margin-bottom: 5px;">Plan de Construcci√≥n Unidades Funcionales (UF)</h1>
        <p style="color: var(--text-sub);">Estimaci√≥n basada en fechas contractuales oficiales (Fuente: Tabla Maestra
          UF)</p>
      </div>
      <div>
        <button class="tm01-btn" onclick="window.print()">üñ®Ô∏è Informe PDF</button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="tm01-grid-4" style="margin-bottom: var(--space-xl);">
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mDuracion">-</div>
        <div class="tm01-stat-label">Duraci√≥n Total (Meses)</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mUFs">-</div>
        <div class="tm01-stat-label">Unidades Funcionales</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mFinProyecto" style="font-size: 1.2rem; color: var(--tm01-primary);">-</div>
        <div class="tm01-stat-label">Fecha Fin Proyecto</div>
      </div>
      <div class="tm01-stat">
        <div class="tm01-stat-value" id="mAvanceEstimado" style="color: var(--success);">0%</div>
        <div class="tm01-stat-label">Avance Te√≥rico (Hoy)</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="tm01-card" style="margin-bottom: var(--space-lg);">
      <div style="display: flex; gap: var(--space-md); flex-wrap: wrap; align-items: end;">
        <div style="flex: 1;">
          <label style="display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.9em;">Fase</label>
          <select id="fFase" onchange="aplicarFiltros()" class="tm01-btn"
            style="width: 100%; background: white; border-color: var(--border);">
            <option value="">Todas las Fases</option>
          </select>
        </div>
        <div style="flex: 2;">
          <label style="display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.9em;">B√∫squeda</label>
          <input id="fBuscar" placeholder="Buscar actividad..." oninput="aplicarFiltros()" class="tm01-btn"
            style="width: 100%; background: white; border-color: var(--border); cursor: text;" />
        </div>
      </div>
    </div>

    <!-- Gantt Table -->
    <div class="tm01-section">
      <div class="tm01-section-header">üìä Visualizaci√≥n Gantt</div>
      <div class="tm01-section-content" style="padding: 0;">
        <div style="overflow-x: auto;">
          <table class="tm01-table" id="tabla">
            <thead>
              <tr>
                <th style="width: 15%">Fase / Tipo</th>
                <th style="width: 25%">Actividad (UF)</th>
                <th style="width: 15%; text-align: center;">Fecha Fin</th>
                <th style="width: 10%; text-align: center;">Plazo (Meses)</th>
                <th style="width: 35%">Cronograma</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: var(--text-muted);">Cargando
                  Cronograma...</td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- Legend -->
        <div style="padding: 10px 20px; display: flex; gap: 20px; border-top: 1px solid var(--border);">
          <div style="display: flex; align-items: center; gap: 5px; font-size: 0.85em; color: var(--text-sub);">
            <span style="width: 12px; height: 12px; background: var(--tm01-accent); border-radius: 2px;"></span>
            Ejecuci√≥n
          </div>
          <div style="display: flex; align-items: center; gap: 5px; font-size: 0.85em; color: var(--text-sub);">
            <span style="width: 12px; height: 12px; background: var(--warning); border-radius: 50%;"></span> Hito de
            Entrega
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div style="margin: var(--space-2xl) 0; color: var(--text-muted); font-size: 0.8em; text-align: center;">
      <p><strong>TM01 Troncal Magdalena</strong> - Sistema de Gesti√≥n Contractual</p>
      <p>Datos conciliados con Interventor√≠a | Ref: Tablas Maestras</p>
    </div>

  </div>

  <!-- Scripts -->
  <script src="data/tm01_master_data.js?v=20260130b"></script>
  <script>
    const MS_DAY = 86400000;
    let allTasks = [], filtered = [];

    function parseDate(s) {
      if (!s) return null;
      const parts = s.split('-');
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function fmt(d) {
      if (!d) return '-';
      return d.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function diffMonths(start, end) {
      if (!start || !end) return 0;
      return ((end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + (end.getDate() - start.getDate()) / 30).toFixed(1);
    }

    function init() {
      if (!window.tm01MasterData) { setTimeout(init, 200); return; }

      const md = window.tm01MasterData.data;
      // Filter only valid entries from master data cronograma
      allTasks = (md.cronograma || []).map(t => ({
        ...t,
        dInicio: parseDate(t.inicio),
        dFin: parseDate(t.fin)
      })).sort((a, b) => a.dInicio - b.dInicio);

      if (allTasks.length === 0) console.warn("No cronograma data!");

      poblarFiltros();
      aplicarFiltros();
    }

    function poblarFiltros() {
      const fases = [...new Set(allTasks.map(t => t.fase))];
      const selF = document.getElementById('fFase');
      selF.innerHTML = '<option value="">Todas las Fases</option>';
      fases.forEach(f => {
        if (f) { const o = document.createElement('option'); o.value = f; o.textContent = f; selF.appendChild(o); }
      });
    }

    function aplicarFiltros() {
      const fF = document.getElementById('fFase').value;
      const q = document.getElementById('fBuscar').value.toLowerCase();

      filtered = allTasks.filter(t => {
        if (fF && t.fase !== fF) return false;
        if (q && !t.nombre.toLowerCase().includes(q)) return false;
        return true;
      });

      calculateMetrics();
      renderTable();
    }

    function calculateMetrics() {
      if (filtered.length === 0) return;

      const dates = filtered.map(t => t.dInicio).concat(filtered.map(t => t.dFin)).filter(d => d);
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));

      document.getElementById('mDuracion').textContent = diffMonths(minDate, maxDate);
      document.getElementById('mUFs').textContent = filtered.filter(t => t.nombre.startsWith('UF')).length;
      document.getElementById('mFinProyecto').textContent = fmt(maxDate);

      // Avance Teorico Simple (Tiempo transcurrido vs total)
      const hoy = new Date();
      const totalTime = maxDate - minDate;
      const elapsedTime = hoy - minDate;
      let avance = 0;
      if (elapsedTime > 0 && totalTime > 0) {
        avance = Math.min(100, Math.max(0, (elapsedTime / totalTime) * 100)).toFixed(1);
      }
      document.getElementById('mAvanceEstimado').textContent = `${avance}%`;

      // Globals for Gantt
      window._minGlobal = minDate;
      window._spanGlobal = totalTime;
    }

    function renderTable() {
      const tb = document.querySelector('#tabla tbody');
      if (filtered.length === 0) { tb.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Sin resultados</td></tr>'; return; }

      const minT = window._minGlobal ? window._minGlobal.getTime() : 0;
      const spanT = window._spanGlobal || 1;

      tb.innerHTML = filtered.map(t => {
        const ini = t.dInicio ? t.dInicio.getTime() : minT;
        const fin = t.dFin ? t.dFin.getTime() : ini;

        // Gantt Calculation
        const offsetPct = ((ini - minT) / spanT) * 100;
        let widthPct = Math.max(((fin - ini) / spanT) * 100, 0.5);

        let vizHtml;
        if (t.hito) {
          // Milestone
          vizHtml = `<div class="gantt-wrapper" style="background: transparent;">
                        <div style="width: ${offsetPct}%;"></div>
                        <div class="gantt-milestone" title="Hito de Entrega: ${fmt(t.dFin)}"></div>
                     </div>`;
        } else {
          // Bar
          vizHtml = `<div class="gantt-wrapper">
                        <div style="width: ${offsetPct}%; flex-shrink: 0;"></div>
                        <div class="gantt-bar" style="width: ${widthPct}%;" title="${fmt(t.dInicio)} - ${fmt(t.dFin)}"></div>
                    </div>`;
        }

        // Status Pill logic
        let pillClass = 'construction';
        if (t.fase.includes('0.')) pillClass = 'pre';
        if (t.fase.includes('Fibra') || t.fase.includes('ITS')) pillClass = 'transversal';

        return `
                    <tr>
                        <td style="vertical-align: middle;">
                            <span class="status-pill ${pillClass}">${t.fase}</span>
                        </td>
                        <td style="vertical-align: middle;">
                            <div style="font-weight: 600; color: var(--text-main);">${t.nombre}</div>
                            ${t.nota ? `<div style="font-size: 0.8em; color: var(--text-muted); margin-top: 2px;">${t.nota}</div>` : ''}
                        </td>
                        <td style="text-align: center; vertical-align: middle; font-family: monospace;">
                            ${fmt(t.dFin)}
                        </td>
                        <td style="text-align: center; vertical-align: middle;">
                            ${t.hito ? '<span style="color:var(--warning); font-weight:bold; font-size:0.8em;">üèÅ HITO</span>' : diffMonths(t.dInicio, t.dFin)}
                        </td>
                        <td style="vertical-align: middle; padding: 4px 10px;">
                            ${vizHtml}
                        </td>
                    </tr>
                `;
      }).join('');
    }

    function exportarExcel() {
      const rows = filtered.map(t => ({
        Fase: t.fase,
        Actividad: t.nombre,
        Inicio: fmt(t.dInicio),
        Fin: fmt(t.dFin),
        Duracion_Meses: diffMonths(t.dInicio, t.dFin),
        Nota: t.nota || ''
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cronograma_Conciliado");
      XLSX.writeFile(wb, "Cronograma_TM01_Conciliado.xlsx");
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>

</html>
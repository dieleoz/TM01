<!DOCTYPE html>
<html lang="es">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Gerencial - TM01 Troncal Magdalena</title>
    <style>
        :root {
            --g1: #0f172a;
            --g2: #1e293b;
            --h1: #0f172a;
            --h2: #2563eb;
            --bg: #f8f9fa;
            --card: #ffffff;
            --line: #dee2e6;
            --text: #212529;
            --muted: #6c757d;
            --accent: #667eea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .toolbar {
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--g1), var(--g2));
            border-bottom: 1px solid rgba(0, 0, 0, .06);
        }

        .btn {
            padding: 10px 14px;
            border: 1px solid rgba(255, 255, 255, .6);
            border-radius: 8px;
            background: rgba(255, 255, 255, .15);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: rgba(255, 255, 255, .2);
        }

        .btn-success {
            background: #28a745;
            border-color: #28a745;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .hero {
            background: linear-gradient(135deg, var(--g1), var(--g2));
            border-radius: 14px;
            padding: 36px 26px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, .15);
            color: #fff;
        }

        .hero h1 {
            font-size: 30px;
            margin-bottom: 6px;
        }

        .hero p {
            opacity: .95;
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 14px;
            margin: 18px 0;
        }

        .metric {
            background: var(--card);
            border: 1px solid var(--line);
            padding: 16px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .06);
        }

        .metric .val {
            font-size: 22px;
            font-weight: 800;
            color: var(--accent);
        }

        .metric .lab {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        .section {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 12px;
            margin: 18px 0;
            overflow: hidden;
            box-shadow: 0 6px 20px rgba(0, 0, 0, .05);
        }

        .section h2 {
            background: #ffffff;
            color: var(--h1);
            padding: 14px 16px;
            border-bottom: 1px solid var(--line);
            font-size: 18px;
        }

        .content {
            padding: 16px;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, .05);
        }

        .card h3 {
            font-size: 14px;
            color: var(--h2);
            margin-bottom: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border: 1px solid var(--line);
        }

        th {
            background: var(--h1);
            color: #fff;
            padding: 10px;
            text-align: left;
            font-size: 13px;
        }

        td {
            padding: 10px;
            border-top: 1px solid var(--line);
            font-size: 13px;
            color: var(--text);
        }

        .right {
            text-align: right;
        }

        .muted {
            color: var(--muted);
            font-size: 12px;
        }

        @media print {
            .toolbar {
                display: none;
            }

            body {
                background: #fff;
                color: #000;
            }

            .hero,
            .section,
            .card,
            .metric {
                box-shadow: none;
                border-color: #ddd;
            }

            th {
                background: #333
            }
        }
    </style>
</head>

<body>
    <div class="toolbar">
        <a href="WBS_Menu_Principal.html" class="btn" style="margin-right: auto;">‚Üê Volver al Inicio</a>
        <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-success" onclick="exportarExcelReporte()">üìä Exportar Excel</button>
    </div>

    <div class="wrap">
        <div class="hero">
            <h1>üìã REPORTE GERENCIAL EJECUTIVO</h1>
            <p>TM01 Troncal Magdalena | Sistema de Validaci√≥n ITS | √ölt. act.: <span id="fechaAct"></span></p>
            <div class="grid">
                <div class="metric">
                    <div class="val" id="mUSD">-</div>
                    <div class="lab">Presupuesto Total (USD)</div>
                </div>
                <div class="metric">
                    <div class="val" id="mCOP">-</div>
                    <div class="lab">Presupuesto Total (COP)</div>
                </div>
                <div class="metric">
                    <div class="val" id="mItems">-</div>
                    <div class="lab">Items WBS (tipo item)</div>
                </div>
                <div class="metric">
                    <div class="val" id="mSistemas">-</div>
                    <div class="lab">Sistemas</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìä Pareto 80% del Presupuesto</h2>
            <div class="content">
                <table id="tablaPareto">
                    <thead>
                        <tr>
                            <th>√ë¬çtem</th>
                            <th>Descripci√≥n</th>
                            <th>Sistema</th>
                            <th class="right">Total (COP)</th>
                            <th class="right">Total (USD)</th>
                            <th class="right">% Acum.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="muted">Calculando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>üìä Justificaci√≥n de Cantidades por Sistema</h2>
            <div class="content">
                <table id="tablaSistemas">
                    <thead>
                        <tr>
                            <th>Sistema</th>
                            <th class="right">Cantidad Total</th>
                            <th>Justificaci√≥n T√©cnica</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Supuestos T√©cnicos y Comerciales</h2>
            <div class="content cards" id="supuestosCards">
                <div class="card">
                    <h3>Arquitectura</h3>
                    <div class="muted">5 capas: Fuente ‚Üí DTs ‚Üí Ingenier√≠a ‚Üí Motor Datos ‚Üí Services/Entrega</div>
                </div>
                <div class="card">
                    <h3>Comunicaciones</h3>
                    <div class="muted">Fibra √≥ptica backbone; energ√≠a aut√≥noma en equipos remotos</div>
                </div>
                <div class="card">
                    <h3>Comerciales</h3>
                    <div class="muted">AIU 33% (Adm 23% + Imp 5% + Util 5%). IVA: SUM y SERV 19%; Utilidad OBRA 19% √ó 5%
                    </div>
                </div>
                <div class="card">
                    <h3>TRM</h3>
                    <div class="muted">4,400 COP/USD</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚öôÔ∏è Riesgos Principales</h2>
            <div class="content cards" id="riesgosCards">
                <div class="card">
                    <h3>Interoperabilidad</h3>
                    <div class="muted">Integraci√≥n con terceros requiere pruebas conjuntas y protocolos est√°ndar.</div>
                </div>
                <div class="card">
                    <h3>Disponibilidad FO</h3>
                    <div class="muted">Cobertura de 293 km; asegurar suministro y redundancias.</div>
                </div>
                <div class="card">
                    <h3>Suministro y Plazos</h3>
                    <div class="muted">Cumplimiento de plazos contractuales por UF; coordinar entregas cr√≠ticas (UF5,
                        UF0-M36).</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚úÖ Recomendaciones Estrat√©gicas</h2>
            <div class="content cards">
                <div class="card">
                    <h3>Foco PMO</h3>
                    <div class="muted">Supervisi√≥n intensiva a √ë¬çtems Pareto 80%.</div>
                </div>
                <div class="card">
                    <h3>QA Datos</h3>
                    <div class="muted">Validar coherencia WBS, Presupuesto y Layout en cada sincronizaci√≥n.</div>
                </div>
                <div class="card">
                    <h3>DTs</h3>
                    <div class="muted">Registrar y trazar todas las Decisiones T√©cnicas con impacto.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="data/tm01_master_data.js?v=20251209"></script>
    <script src="datos_wbs_TM01_items.js?v=20251209"></script>
    <script>
        function n(v) { const x = parseFloat((v ?? '').toString().replace(/[^0-9.\-]/g, '')); return isNaN(x) ? 0 : x; }
        function fm(n, curr) { return new Intl.NumberFormat(curr === 'USD' ? 'en-US' : 'es-CO', { style: 'currency', currency: curr || 'COP', maximumFractionDigits: 0 }).format(n); }
        function sum(arr, fn) { return arr.reduce((s, a) => s + (fn ? fn(a) : a), 0); }

        function init() {
            // Unificar fuentes de datos (Soporte para TM01MasterData clase o TM01_MASTER_DATA objeto global)
            const md = (typeof window.tm01MasterData !== 'undefined') ? window.tm01MasterData :
                (typeof window.TM01_MASTER_DATA !== 'undefined' ? { data: window.TM01_MASTER_DATA } : null);

            const wbsData = (typeof window.wbsDataGlobal !== 'undefined') ? window.wbsDataGlobal : null;

            if (!md && !wbsData) { setTimeout(init, 100); return; }

            // Determinar items y fecha de actualizaci√≥n
            let items = [];
            let fechaDatos = 'Desconocida';

            if (wbsData && wbsData.items && wbsData.items.length > 0) {
                // Prioridad: Datos detallados WBS
                items = wbsData.items.filter(i => i.tipo === 'item');
                fechaDatos = wbsData.fecha_actualizacion || wbsData.fecha_generacion || new Date().toLocaleDateString();
            } else if (md && md.data) {
                // Fallback: Master Data (puede ser simplificado o detallado)
                // Soporte para estructura wbs.items o tm01Data.data.wbs
                const wbsArray = Array.isArray(md.data.wbs) ? md.data.wbs :
                    (md.data.wbs && md.data.wbs.items) ? md.data.wbs.items : [];
                items = wbsArray.filter(i => i && i.tipo === 'item');

                // Intentar obtener fecha del resumen
                if (md.data.resumen && md.data.resumen.fechaActualizacion) {
                    fechaDatos = md.data.resumen.fechaActualizacion;
                }
            }

            const totalUSD = sum(items, i => n(i.cantidad) * n(i.vu));
            const totalCOP = sum(items, i => n(i.totalCOP) || (n(i.cantidad) * n(i.vuCOP)));
            const sistemas = new Set(items.map(i => i.sistema).filter(Boolean));

            document.getElementById('mUSD').textContent = fm(totalUSD, 'USD');
            document.getElementById('mCOP').textContent = fm(totalCOP, 'COP');
            document.getElementById('mItems').textContent = items.length;
            document.getElementById('mSistemas').textContent = sistemas.size;

            // Mostrar fecha de datos + fecha actual reporte
            const fechaReporte = new Date().toLocaleString('es-CO');
            document.getElementById('fechaAct').innerHTML = `${fechaDatos} <br><small class='muted'>(Reporte: ${fechaReporte})</small>`;

            const trm = window.TRM_OFICIAL || 4000;
            const byValue = items.map(i => ({ item: i.item, desc: i.descripcion, sistema: i.sistema, cop: n(i.totalCOP) || (n(i.cantidad) * n(i.vuCOP)) })).sort((a, b) => b.cop - a.cop);
            let acc = 0; const pareto = []; const total = sum(byValue, v => v.cop);
            for (const r of byValue) { acc += r.cop; pareto.push({ ...r, pctAcc: (acc / total) * 100 }); if (acc / total >= 0.8) break; }
            const tbp = document.querySelector('#tablaPareto tbody');
            tbp.innerHTML = pareto.map(r => `<tr><td>${r.item}</td><td>${r.desc}</td><td>${r.sistema || ''}</td><td class="right">${fm(r.cop, 'COP')}</td><td class="right">${fm(r.cop / trm, 'USD')}</td><td class="right">${r.pctAcc.toFixed(1)}%</td></tr>`).join('');

            const just = {};
            items.forEach(i => { const s = i.sistema || 'SIN SISTEMA'; if (!just[s]) just[s] = { cant: 0, criterio: i.criterio || 'Criterio t√©cnico aplicado' }; just[s].cant += n(i.cantidad) || 0; if (i.criterio) just[s].criterio = i.criterio; });
            const tbs = document.querySelector('#tablaSistemas tbody');
            tbs.innerHTML = Object.keys(just).sort().map(s => `<tr><td><strong>${s}</strong></td><td class="right">${just[s].cant}</td><td>${just[s].criterio}</td></tr>`).join('');

            window.__reporteData = { totalUSD, totalCOP, items, pareto, just };
        }

        function exportarExcelReporte() {
            if (!window.__reporteData) { alert('Espere a que carguen los datos...'); return; }
            const { totalUSD, totalCOP, pareto, just } = window.__reporteData;
            const data = [['REPORTE GERENCIAL - TM01'], ['Fecha', new Date().toLocaleString('es-CO')], [], ['M√©trica', 'Valor'], ['Total (USD)', totalUSD], ['Total (COP)', totalCOP], [], ['PARETO 80% - √ë¬çtems'], ['√ë¬çtem', 'Descripci√≥n', 'Sistema', 'Total (COP)', 'Total (USD)', '% Acum']];
            pareto.forEach(p => data.push([p.item, p.desc, p.sistema, p.cop, p.cop / 4400, p.pctAcc]));
            data.push([]); data.push(['Justificaci√≥n por Sistema']); data.push(['Sistema', 'Cantidad Total', 'Criterio']);
            Object.keys(just).sort().forEach(s => data.push([s, just[s].cant, just[s].criterio]));
            const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols'] = [{ wch: 16 }, { wch: 60 }, { wch: 18 }, { wch: 18 }, { wch: 16 }, { wch: 10 }];
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Reporte Gerencial');
            const fname = 'Reporte_Gerencial_TM01_' + new Date().toISOString().split('T')[0] + '.xlsx';
            XLSX.writeFile(wb, fname);
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</body>

</html>
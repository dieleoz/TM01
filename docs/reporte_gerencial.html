<!DOCTYPE html>
<html lang="es">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Gerencial - TM01 Troncal Magdalena</title>

    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Estilos Design System -->
    <link rel="stylesheet" href="css/tm01-design-system.css">

    <style>
        /* Estilos espec√≠ficos para este reporte si son necesarios */
        .metric-grid {
            margin-bottom: var(--space-xl);
        }

        .critical-alert {
            background: var(--warning-bg);
            border: 1px solid var(--warning);
            color: #92400e;
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .critical-alert svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .highlight-sos {
            border-left: 4px solid var(--tm01-accent);
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="tm01-navbar">
        <div class="tm01-brand">
            üìã Reporte Gerencial Ejecutivo
            <span class="tm01-status-badge">TM01 Troncal Magdalena</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="WBS_Menu_Principal.html" class="tm01-btn tm01-btn-link">‚Üê Volver al Inicio</a>
            <button class="tm01-btn" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            <button class="tm01-btn tm01-btn-success" onclick="exportarExcelReporte()">üìä Exportar Excel</button>
        </div>
    </nav>

    <div class="tm01-container" style="padding-top: var(--space-xl);">

        <!-- Header / Info -->
        <div style="margin-bottom: var(--space-lg);">
            <p style="color: var(--text-sub);">Sistema de Validaci√≥n ITS | √öltima actualizaci√≥n: <span id="fechaAct"
                    style="font-weight: 600;">Cargando...</span></p>
        </div>

        <!-- M√©tricas Principales -->
        <div class="tm01-grid-4 metric-grid">
            <div class="tm01-stat">
                <div class="tm01-stat-value" id="mUSD">-</div>
                <div class="tm01-stat-label">Presupuesto Total (USD)</div>
            </div>
            <div class="tm01-stat">
                <div class="tm01-stat-value" id="mCOP">-</div>
                <div class="tm01-stat-label">Presupuesto Total (COP)</div>
            </div>
            <div class="tm01-stat">
                <div class="tm01-stat-value" id="mItems">-</div>
                <div class="tm01-stat-label">Items WBS</div>
            </div>
            <div class="tm01-stat">
                <div class="tm01-stat-value" id="mSistemas">-</div>
                <div class="tm01-stat-label">Sistemas</div>
            </div>
        </div>

        <!-- SECCI√ìN CR√çTICA: SOS -->
        <div class="critical-alert highlight-sos">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <div>
                <strong>Entrega Temprana: Sistema SOS</strong>
                <p style="margin: 4px 0 0 0; font-size: 0.9rem;">
                    Operaci√≥n gradual y paralela al progreso de obras.
                    El sistema estar√° <strong>100% operativo</strong> al inicio de la etapa de operaci√≥n. Prioridad
                    estrat√©gica.
                </p>
            </div>
        </div>

        <!-- Pareto 80/20 -->
        <div class="tm01-section">
            <div class="tm01-section-header">üìä Pareto 80% del Presupuesto</div>
            <div class="tm01-section-content">
                <div style="overflow-x: auto;">
                    <table class="tm01-table" id="tablaPareto">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Descripci√≥n</th>
                                <th>Sistema</th>
                                <th style="text-align: right;">Total (COP)</th>
                                <th style="text-align: right;">Total (USD)</th>
                                <th style="text-align: right;">% Acum.</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    Calculando Pareto...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tm01-grid-2">
            <!-- Justificaci√≥n por Sistema -->
            <div class="tm01-section">
                <div class="tm01-section-header">üìä Justificaci√≥n de Cantidades</div>
                <div class="tm01-section-content">
                    <table class="tm01-table" id="tablaSistemas">
                        <thead>
                            <tr>
                                <th>Sistema</th>
                                <th style="text-align: right;">Cant. Total</th>
                                <th>Justificaci√≥n T√©cnica</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Supuestos T√©cnicos -->
            <div class="tm01-section">
                <div class="tm01-section-header">‚öôÔ∏è Supuestos T√©cnicos y Comerciales</div>
                <div class="tm01-section-content" style="display: flex; flex-direction: column; gap: var(--space-md);">
                    <div class="tm01-card" style="padding: var(--space-md);">
                        <h3>Arquitectura 5 Capas</h3>
                        <p style="margin:0;">Fuente ‚Üí DTs ‚Üí Ingenier√≠a ‚Üí Motor Datos ‚Üí Services/Entrega</p>
                    </div>
                    <div class="tm01-card" style="padding: var(--space-md);">
                        <h3>Comunicaciones</h3>
                        <p style="margin:0;">Fibra √≥ptica backbone 293km; energ√≠a aut√≥noma en sitios cr√≠ticos.</p>
                    </div>
                    <div class="tm01-card" style="padding: var(--space-md);">
                        <h3>Comerciales</h3>
                        <p style="margin:0;">AIU 33%. TRM Base: 4,400 COP/USD. Utilidad Obra 5% sobre 19%.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Riesgos y Recomendaciones -->
        <div class="tm01-grid-2">
            <div class="tm01-section">
                <div class="tm01-section-header">‚ö†Ô∏è Riesgos Principales</div>
                <div class="tm01-section-content">
                    <ul
                        style="list-style: none; padding: 0; display: flex; flex-direction: column; gap: var(--space-md);">
                        <li style="background: var(--bg-hover); padding: 10px; border-radius: var(--radius-md);">
                            <strong>Interoperabilidad:</strong> Integraci√≥n con terceros (Peajes/Inv√≠as) requiere
                            protocolos estrictos.
                        </li>
                        <li style="background: var(--bg-hover); padding: 10px; border-radius: var(--radius-md);">
                            <strong>Log√≠stica de Acopios:</strong> Lote 3 (Feb 2027) es cr√≠tico para UF11.
                        </li>
                        <li style="background: var(--bg-hover); padding: 10px; border-radius: var(--radius-md);">
                            <strong>Ruta Cr√≠tica:</strong> UF11 y UF5.1 (Fin Oct 2028). Sin margen de holgura.
                        </li>
                    </ul>
                </div>
            </div>

            <div class="tm01-section">
                <div class="tm01-section-header">‚úÖ Recomendaciones Estrat√©gicas</div>
                <div class="tm01-section-content">
                    <div class="tm01-card"
                        style="background: var(--success-bg); border-color: var(--success); padding: var(--space-md);">
                        <h3 style="color: #065f46; font-size: 1rem;">Optimizaci√≥n Financiera CCO</h3>
                        <p style="color: #064e3b; margin:0; font-size: 0.9rem;">Certificado: $845k USD (Ahorro $1.5M).
                            Mantener arquitectura COTS abierta.</p>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: var(--text-sub);">
                        <p>‚Ä¢ <strong>Provisi√≥n Lotes:</strong> Asegurar Lote 1 en Feb 2026 para flujo inicial.</p>
                        <p>‚Ä¢ <strong>Foco UF11:</strong> Seguimiento semanal a frentes de obra en el tramo m√°s largo.
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="data/tm01_master_data.js?v=20260128"></script>
    <script src="datos_wbs_TM01_items.js?v=20260128"></script>
    <script>
        function n(v) { const x = parseFloat((v ?? '').toString().replace(/[^0-9.\-]/g, '')); return isNaN(x) ? 0 : x; }
        function fm(n, curr) { return new Intl.NumberFormat(curr === 'USD' ? 'en-US' : 'es-CO', { style: 'currency', currency: curr || 'COP', maximumFractionDigits: 0 }).format(n); }
        function sum(arr, fn) { return arr.reduce((s, a) => s + (fn ? fn(a) : a), 0); }

        function init() {
            const md = (typeof window.tm01MasterData !== 'undefined') ? window.tm01MasterData : null;

            if (!md) {
                console.warn("Esperando Master Data...");
                setTimeout(init, 200);
                return;
            }

            // Usar m√©todo oficial para obtener estad√≠sticas
            const stats = md.getEstadisticas();
            const resumenContractual = md.getContractualSummary();
            const items = md.getWBSItems();

            // Calcular totales generales
            let totalUSD = 0, totalCOP = 0;
            const sistemasSet = new Set();

            items.forEach(i => {
                totalUSD += n(i.totalUSD || i.total);
                totalCOP += n(i.totalCOP);
                if (i.sistema) sistemasSet.add(i.sistema);
            });

            // Renderizar M√©tricas
            document.getElementById('mUSD').textContent = fm(totalUSD, 'USD');
            document.getElementById('mCOP').textContent = fm(totalCOP, 'COP');
            document.getElementById('mItems').textContent = items.length;
            document.getElementById('mSistemas').textContent = sistemasSet.size;

            // Fecha
            const fechaReporte = new Date().toLocaleString('es-CO');
            document.getElementById('fechaAct').innerHTML = `${new Date().toLocaleDateString()} <small class='text-muted'>(Generado: ${fechaReporte})</small>`;

            // Pareto logic
            const trm = 4400; // Podr√≠a venir de config
            const byValue = items.map(i => ({
                item: i.item,
                desc: i.descripcion,
                sistema: i.sistema,
                cop: n(i.totalCOP),
                usd: n(i.total)
            })).sort((a, b) => b.cop - a.cop);

            let acc = 0;
            const pareto = [];
            const totalPareto = sum(byValue, v => v.cop);

            for (const r of byValue) {
                acc += r.cop;
                pareto.push({ ...r, pctAcc: (acc / totalPareto) * 100 });
                if (acc / totalPareto >= 0.8) break;
            }

            const tbp = document.querySelector('#tablaPareto tbody');
            tbp.innerHTML = pareto.map(r => `
                <tr>
                    <td style="font-family:monospace; font-weight:bold;">${r.item}</td>
                    <td>${r.desc}</td>
                    <td><span class="tm01-status-badge" style="background:var(--info-bg); color:var(--tm01-accent);">${r.sistema || '-'}</span></td>
                    <td style="text-align:right;">${fm(r.cop, 'COP')}</td>
                    <td style="text-align:right;">${fm(r.usd, 'USD')}</td>
                    <td style="text-align:right; font-weight:bold;">${r.pctAcc.toFixed(1)}%</td>
                </tr>`).join('');

            // Justificaci√≥n por Sistema
            const tbs = document.querySelector('#tablaSistemas tbody');
            if (resumenContractual.length > 0) {
                tbs.innerHTML = resumenContractual.map(s => `
                    <tr>
                        <td><strong>${s.sistema}</strong></td>
                        <td style="text-align:right;">${Math.round(s.cantidad) || '-'}</td>
                        <td style="color:var(--text-sub); font-size:0.85rem;">Validado (Hard Deck Audit 5.0)</td>
                    </tr>`).join('');
            } else {
                tbs.innerHTML = '<tr><td colspan="3" class="text-muted">No se encontraron datos.</td></tr>';
            }

            // Store data for export
            window.__reporteData = { totalUSD, totalCOP, items, pareto };
        }

        function exportarExcelReporte() {
            if (!window.__reporteData) { alert('Espere a que carguen los datos...'); return; }
            const { totalUSD, totalCOP, pareto } = window.__reporteData;

            const ws_data = [
                ['REPORTE GERENCIAL EJECUTIVO - TM01'],
                ['Fecha Generaci√≥n', new Date().toLocaleString('es-CO')],
                [],
                ['M√©trica Global', 'Valor'],
                ['Total Presupuesto (USD)', totalUSD],
                ['Total Presupuesto (COP)', totalCOP],
                [],
                ['AN√ÅLISIS DE PARETO (80% DEL COSTO)'],
                ['Item', 'Descripci√≥n', 'Sistema', 'Costo (COP)', 'Costo (USD)', '% Acumulado']
            ];

            pareto.forEach(p => ws_data.push([
                p.item,
                p.desc,
                p.sistema,
                p.cop,
                p.usd,
                p.pctAcc / 100
            ]));

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte Gerencial");
            XLSX.writeFile(wb, "Reporte_Gerencial_TM01.xlsx");
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
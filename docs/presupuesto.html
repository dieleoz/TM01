<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Presupuestal - TM01 Troncal Magdalena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1500px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; padding: 28px; text-align: center; position: relative; }
        .header h1 { font-size: 26px; margin-bottom: 8px; font-weight: 600; }
        .header p { opacity: .95; font-size: 14px; }
        .back-btn { position: absolute; top: 18px; left: 18px; background: rgba(255,255,255,0.2); color: #fff; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .controls { padding: 16px 20px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: .2s; }
        .btn-primary { background: #667eea; color: #fff; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover { background: #218838; }
        .filter-group { margin-left: auto; display: flex; gap: 10px; align-items: center; }
        .filter-group label { font-size: 13px; color: #495057; }
        .filter-group select, .filter-group input { padding: 8px 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; }
        .stats { padding: 18px 20px; background: #d1ecf1; border-bottom: 1px solid #bee5eb; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .stat { background: #fff; border-left: 4px solid #17a2b8; border-radius: 8px; padding: 14px; }
        .stat .label { color: #6c757d; font-size: 12px; text-transform: uppercase; letter-spacing: .4px; }
        .stat .value { margin-top: 6px; font-size: 20px; font-weight: 700; color: #1e3c72; }
        .table-container { padding: 18px 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { position: sticky; top: 0; z-index: 10; background: #1e3c72; color: #fff; }
        th, td { padding: 10px 12px; border-bottom: 1px solid #e9ecef; font-size: 13px; text-align: left; }
        tbody tr:hover { background: #f8f9fa; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
        .badge-sistema { background: #e3f2fd; color: #1976d2; }
        .right { text-align: right; }
        .footer { background: #343a40; color: #fff; text-align: center; padding: 14px; font-size: 12px; }
        @media (max-width: 768px) { .filter-group { width: 100%; margin-left: 0; } .filter-group select, .filter-group input { flex: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="window.location.href='WBS_Menu_Principal.html'">‚Üê Volver al Men√∫</button>
            <h1>üí∞ WBS PRESUPUESTAL</h1>
            <p>TM01 Troncal Magdalena | C√°lculos AIU/IVA y Exportaci√≥n</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="aplicarFiltros()">üîç Aplicar</button>
            <button class="btn" onclick="limpiarFiltros()">üîÑ Limpiar</button>
            <button class="btn btn-success" onclick="exportarExcel()">üìä Exportar Excel</button>
            <div class="filter-group">
                <label for="fSistema">Sistema:</label>
                <select id="fSistema"></select>
                <label for="fBuscar">Buscar:</label>
                <input id="fBuscar" type="text" placeholder="C√≥digo o descripci√≥n" oninput="aplicarFiltros()" />
            </div>
        </div>

        <div class="stats">
            <div class="stat"><div class="label">Total USD</div><div class="value" id="statUSD">-</div></div>
            <div class="stat"><div class="label">Total COP</div><div class="value" id="statCOP">-</div></div>
            <div class="stat"><div class="label">AIU (33%)</div><div class="value" id="statAIU">-</div></div>
            <div class="stat"><div class="label">IVA Servicios (19%)</div><div class="value" id="statIVA">-</div></div>
            <div class="stat"><div class="label">Items</div><div class="value" id="statItems">-</div></div>
        </div>

        <div class="table-container">
            <table id="tablaPresupuesto">
                <thead>
                    <tr>
                        <th>√çtem</th>
                        <th>Descripci√≥n</th>
                        <th>Sistema</th>
                        <th class="right">Cant.</th>
                        <th>Und</th>
                        <th class="right">VU USD</th>
                        <th class="right">Total USD</th>
                        <th class="right">VU COP</th>
                        <th class="right">Total COP</th>
                    </tr>
                </thead>
                <tbody id="tbodyPresupuesto">
                    <tr><td colspan="9" style="text-align:center;color:#6c757d; padding: 18px;">‚è≥ Cargando datos presupuestales...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            √öltima actualizaci√≥n: <span id="fechaActual"></span>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="data/tm01_master_data.js"></script>
    <script>
        let allItems = [];
        let filteredItems = [];

        function waitForDataAndInit() {
            if (typeof TM01MasterData === 'undefined') { setTimeout(waitForDataAndInit, 60); return; }
            initPresupuesto();
        }

        function initPresupuesto() {
            try {
                const dm = (typeof window.tm01MasterData !== 'undefined') ? window.tm01MasterData : new TM01MasterData();
                const wbs = Array.isArray(dm.data?.wbs) ? dm.data.wbs : [];
                // Tomamos s√≥lo items presupuestales (tipo 'item')
                allItems = wbs.filter(i => i && i.tipo === 'item');
                if (allItems.length === 0) throw new Error('No hay items WBS para presupuesto');
                poblarFiltros();
                filteredItems = [...allItems];
                renderTabla();
                actualizarEstadisticas();
                document.getElementById('fechaActual').textContent = new Date().toLocaleString('es-CO');
            } catch (e) {
                const tb = document.getElementById('tbodyPresupuesto');
                tb.innerHTML = `<tr><td colspan="9" style="padding:18px;color:#dc3545;">‚ùå ${e.message}</td></tr>`;
                console.error('Presupuesto - error de carga:', e);
            }
        }

        function poblarFiltros() {
            const sel = document.getElementById('fSistema');
            sel.innerHTML = '<option value="">Todos</option>';
            const sistemas = Array.from(new Set(allItems.map(i => i.sistema).filter(Boolean))).sort();
            sistemas.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; sel.appendChild(o); });
            sel.onchange = aplicarFiltros;
        }

        function aplicarFiltros() {
            const sistema = document.getElementById('fSistema').value;
            const q = document.getElementById('fBuscar').value.toLowerCase();
            filteredItems = allItems.filter(i => {
                if (sistema && i.sistema !== sistema) return false;
                const texto = `${i.item || ''} ${i.descripcion || ''}`.toLowerCase();
                if (q && !texto.includes(q)) return false;
                return true;
            });
            renderTabla();
            actualizarEstadisticas();
        }

        function limpiarFiltros() {
            document.getElementById('fSistema').value = '';
            document.getElementById('fBuscar').value = '';
            aplicarFiltros();
        }

        function num(val) { const n = parseFloat(String(val).replace(/[^0-9.\-]/g, '')); return isNaN(n) ? 0 : n; }
        function fm(n, curr) {
            if (curr === 'USD') return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(n);
        }

        function renderTabla() {
            const tbody = document.getElementById('tbodyPresupuesto');
            if (filteredItems.length === 0) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#6c757d; padding: 14px;">Sin resultados</td></tr>'; return; }
            tbody.innerHTML = filteredItems.map(i => {
                const cantidad = num(i.cantidad);
                const vuUSD = num(i.vu);
                const totalUSD = cantidad * vuUSD;
                const vuCOP = num(i.vuCOP);
                const totalCOP = num(i.totalCOP) || (cantidad * vuCOP);
                return `
                    <tr>
                        <td>${i.item || ''}</td>
                        <td>${i.descripcion || ''}</td>
                        <td><span class="badge badge-sistema">${i.sistema || ''}</span></td>
                        <td class="right">${cantidad || 0}</td>
                        <td>${i.unidad || ''}</td>
                        <td class="right">${vuUSD ? fm(vuUSD, 'USD') : '-'}</td>
                        <td class="right">${totalUSD ? fm(totalUSD, 'USD') : '-'}</td>
                        <td class="right">${vuCOP ? fm(vuCOP, 'COP') : '-'}</td>
                        <td class="right">${totalCOP ? fm(totalCOP, 'COP') : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function actualizarEstadisticas() {
            const totUSD = filteredItems.reduce((s, i) => s + (num(i.cantidad) * num(i.vu)), 0);
            const totCOP = filteredItems.reduce((s, i) => s + (num(i.totalCOP) || (num(i.cantidad) * num(i.vuCOP))), 0);
            const aiu = totCOP * 0.33;
            const iva = (totCOP + aiu) * 0.19; // aproximaci√≥n con IVA servicios
            document.getElementById('statUSD').textContent = fm(totUSD, 'USD');
            document.getElementById('statCOP').textContent = fm(totCOP, 'COP');
            document.getElementById('statAIU').textContent = fm(aiu, 'COP');
            document.getElementById('statIVA').textContent = fm(iva, 'COP');
            document.getElementById('statItems').textContent = String(filteredItems.length);
        }

        function exportarExcel() {
            if (filteredItems.length === 0) { alert('No hay datos para exportar'); return; }
            const rows = filteredItems.map(i => ({
                Item: i.item || '',
                Descripci√≥n: i.descripcion || '',
                Sistema: i.sistema || '',
                Cantidad: num(i.cantidad),
                Unidad: i.unidad || '',
                'VU USD': num(i.vu),
                'Total USD': num(i.cantidad) * num(i.vu),
                'VU COP': num(i.vuCOP),
                'Total COP': num(i.totalCOP) || (num(i.cantidad) * num(i.vuCOP))
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'WBS Presupuesto');
            XLSX.writeFile(wb, 'WBS_Presupuesto_TM01.xlsx');
        }

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', waitForDataAndInit); } else { waitForDataAndInit(); }
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Presupuestal - TM01 Troncal Magdalena</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1500px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; padding: 28px; text-align: center; position: relative; }
        .header h1 { font-size: 26px; margin-bottom: 8px; font-weight: 600; }
        .header p { opacity: .95; font-size: 14px; }
        .back-btn { position: absolute; top: 18px; left: 18px; background: rgba(255,255,255,0.2); color: #fff; border: none; padding: 10px 14px; border-radius: 6px; cursor: pointer; font-size: 13px; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }
        .controls { padding: 16px 20px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: .2s; }
        .btn-primary { background: #667eea; color: #fff; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover { background: #218838; }
        .filter-group { margin-left: auto; display: flex; gap: 10px; align-items: center; }
        .filter-group label { font-size: 13px; color: #495057; }
        .filter-group select, .filter-group input { padding: 8px 10px; border: 1px solid #ced4da; border-radius: 6px; font-size: 13px; }
        .stats { padding: 18px 20px; background: #d1ecf1; border-bottom: 1px solid #bee5eb; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
        .stat { background: #fff; border-left: 4px solid #17a2b8; border-radius: 8px; padding: 14px; }
        .stat .label { color: #6c757d; font-size: 12px; text-transform: uppercase; letter-spacing: .4px; }
        .stat .value { margin-top: 6px; font-size: 20px; font-weight: 700; color: #1e3c72; }
        .table-container { padding: 18px 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { position: sticky; top: 0; z-index: 10; background: #1e3c72; color: #fff; }
        th, td { padding: 10px 12px; border-bottom: 1px solid #e9ecef; font-size: 13px; text-align: left; }
        tbody tr:hover { background: #f8f9fa; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
        .badge-sistema { background: #e3f2fd; color: #1976d2; }
        .right { text-align: right; }
        .footer { background: #343a40; color: #fff; text-align: center; padding: 14px; font-size: 12px; }
        @media (max-width: 768px) { .filter-group { width: 100%; margin-left: 0; } .filter-group select, .filter-group input { flex: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" onclick="window.location.href='WBS_Menu_Principal.html'">← Volver al Menúú</button>
            <h1>💰 WBS PRESUPUESTAL</h1>
            <p>TM01 Troncal Magdalena | Cálculos AIU/IVA y Exportación</p>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="aplicarFiltros()">🔍 Aplicar</button>
            <button class="btn" onclick="limpiarFiltros()">🗑️ Limpiar</button>
            <button class="btn btn-success" onclick="exportarExcel()">📊 Exportar Excel</button>
            <button class="btn" style="background:#17a2b8;color:#fff;" onclick="exportarDesgloseAIU()">📋 Ver Desglose AIU</button>
            <button class="btn" style="background:#ffc107;color:#212529;" onclick="generarActaObra()">🧾 Ver Acta de Obra</button>
            <div class="filter-group">
                <label for="fSistema">Sistema:</label>
                <select id="fSistema"></select>
                <label for="fUF">UF:</label>
                <select id="fUF"></select>
                <label for="fBuscar">Buscar:</label>
                <input id="fBuscar" type="text" placeholder="Código o descripción" oninput="aplicarFiltros()" />
            </div>
                </div>

        <div class="stats">
            <div class="stat"><div class="label">Total USD</div><div class="value" id="statUSD">-</div></div>
            <div class="stat"><div class="label">Total COP</div><div class="value" id="statCOP">-</div></div>
            <div class="stat"><div class="label">AIU (33% solo OBRA)</div><div class="value" id="statAIU">-</div></div>
            <div class="stat"><div class="label">IVA (SUM+SERV+Util OBRA)</div><div class="value" id="statIVA">-</div></div>
            <div class="stat"><div class="label">Items</div><div class="value" id="statItems">-</div></div>
            <div class="stat"><div class="label"># SUM</div><div class="value" id="statSum">-</div></div>
            <div class="stat"><div class="label"># OBRA</div><div class="value" id="statObra">-</div></div>
            <div class="stat"><div class="label"># SERV</div><div class="value" id="statServ">-</div></div>
                </div>

        <div class="table-container">
            <table id="tablaPresupuesto">
                <thead>
                    <tr>
                        <th>Ñtem</th>
                        <th>Descripción</th>
                        <th>Sistema</th>
                        <th class="right">Cant.</th>
                        <th>Und</th>
                        <th>Tipo</th>
                        <th>UF</th>
                        <th class="right">VU USD</th>
                        <th class="right">Total USD</th>
                        <th class="right">VU COP</th>
                        <th class="right">Total COP</th>
                    </tr>
                </thead>
                <tbody id="tbodyPresupuesto">
                    <tr><td colspan="11" style="text-align:center;color:#6c757d; padding: 18px;">â³ Cargando datos presupuestales...</td></tr>
                </tbody>
            </table>
                </div>

        <div class="table-container" id="desgloseContainer">
            <h3 style="margin:6px 0 10px;color:#1e3c72;">📊 Desglose Presupuestal por Capítulos</h3>
            <table>
                <thead>
                    <tr>
                        <th>Capítulo</th>
                        <th class="right">Suministros (COP)</th>
                        <th class="right">Obra Civil (COP)</th>
                        <th class="right">Servicios (COP)</th>
                        <th class="right">Costo Directo (COP)</th>
                        <th class="right">AIU 33% (COP)</th>
                        <th class="right">IVA (COP)</th>
                        <th class="right">Total (COP)</th>
                        <th class="right">Total (USD)</th>
                    </tr>
                </thead>
                <tbody id="tbodyDesglose"></tbody>
            </table>
            </div>
            
        <div class="footer">
            Última actualización: <span id="fechaActual"></span>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="data/uf_pk_map.js"></script>
    <script src="data/tm01_master_data.js?v=20251031150439"></script>
    <script>
        let allItems = [];
        let filteredItems = [];

        function waitForDataAndInit() {
            if (typeof TM01MasterData === 'undefined') { setTimeout(waitForDataAndInit, 60); return; }
            initPresupuesto();
        }

        function inferTipoPresupuestal(item) {
            const desc = (item.descripcion || '').toLowerCase();
            // Override por item si existe (el consultor puede definirlo antes de cargar la página)
            if (window && window.TM01_TIPO_ITEM && window.TM01_TIPO_ITEM[item.item]) {
                return window.TM01_TIPO_ITEM[item.item];
            }
            if (item.tipo_presupuesto) return item.tipo_presupuesto; // prioridad si viene desde datos
            // Señales claras de suministro
            const esSuministroExplicito = /(\bsuministro\b|\bsuministros\b)/.test(desc);
            // Palabras clave de OBRA CIVIL (instalaciones, obra física, civil y montaje)
            const obraRe = /(instalaci[oó]n|tendido|hincado|zanja|excavaci[oó]n|canalizaci[oó]n|ducto|obra civil|\bobra\b|poste|postes|torre|torres|cimentaci[oó]n|fundaci[oó]n|concreto|anclaje|anclajes|soporte de montaje|montaje|tuber[ií]a|canaleta|bandeja|puesta a tierra|adecuaci[oó]n|soldadur|levante|elevaci[oó]n|demolici[oó]n|vaciado|zapata|plataforma|pavimento|relleno|corte|trinchera|estructura)/;
            // Palabras clave de SERVICIOS (sin obra física)
            const servRe = /(capacitaci[oó]n|documentaci[oó]n|pruebas|\bfat\b|\bsat\b|comisionamiento|mantenimiento|soporte|dise[nñ]o|ingenier[ií]a|configuraci[oó]n|licencia|servicio\b|servicios\b|asesor[ií]a|interventor[ií]a)/;
            // Unidades típicas de obra (indicador adicional)
            const unidad = (item.unidad || '').toLowerCase();
            const unidadObra = /(km|\bml\b|\bm\b|m2|m3|m\^2|m\^3|glb\b)/.test(unidad);

            // Si menciona instalación/obra física, clasificar como OBRA
            if (obraRe.test(desc) || unidadObra) {
                // Evitar falsos positivos donde solo dice "suministro" sin instalación
                if (esSuministroExplicito && !/instalaci[oó]n|montaje|obra/.test(desc)) {
                    return 'SUMINISTRO';
                }
                return 'OBRA';
            }
            // Si son servicios profesionales / pruebas / comisionamiento
            if (servRe.test(desc)) return 'SERVICIO';
            // Caso por defecto
            return 'SUMINISTRO';
        }

        function initPresupuesto() {
            try {
                const dm = (typeof window.tm01MasterData !== 'undefined') ? window.tm01MasterData : new TM01MasterData();
                const wbs = Array.isArray(dm.data?.wbs) ? dm.data.wbs : [];
                // Tomamos sólo items presupuestales (tipo 'item') y proyectamos campos de precio/costo
                // Obtener layout para mapear UF
                const layout = Array.isArray(dm.data?.layout) ? dm.data.layout : [];
                const layoutMap = new Map(layout.map(l => [l.id, l.uf]));
                
                allItems = wbs.filter(i => i && i.tipo === 'item').map(i => ({
                    ...i,
                    _tipoCalc: inferTipoPresupuestal(i),
                    _uf: layoutMap.get(i.id) || 'N/A'
                }));
                if (allItems.length === 0) throw new Error('No hay items WBS para presupuesto');
                poblarFiltros();
                filteredItems = [...allItems];
                renderTabla();
                actualizarEstadisticas();
                renderDesglose();
                document.getElementById('fechaActual').textContent = new Date().toLocaleString('es-CO');
            } catch (e) {
                const tb = document.getElementById('tbodyPresupuesto');
                tb.innerHTML = `<tr><td colspan="11" style="padding:18px;color:#dc3545;">âŒ ${e.message}</td></tr>`;
                console.error('Presupuesto - error de carga:', e);
            }
        }

        function poblarFiltros() {
            const sel = document.getElementById('fSistema');
            sel.innerHTML = '<option value="">Todos</option>';
            const sistemas = Array.from(new Set(allItems.map(i => i.sistema).filter(Boolean))).sort();
            sistemas.forEach(s => { const o = document.createElement('option'); o.value = s; o.textContent = s; sel.appendChild(o); });
            sel.onchange = aplicarFiltros;
            
            // Poblar filtro de UF
            const ufSel = document.getElementById('fUF');
            ufSel.innerHTML = '<option value="">Todas</option>';
            const ufs = Array.from(new Set(allItems.map(i => i._uf || 'N/A').filter(uf => uf && uf !== 'N/A'))).sort((a, b) => {
                const aNum = parseInt(a.replace('UF', '')) || 999;
                const bNum = parseInt(b.replace('UF', '')) || 999;
                return aNum - bNum;
            });
            ufs.forEach(uf => { const o = document.createElement('option'); o.value = uf; o.textContent = uf; ufSel.appendChild(o); });
            ufSel.onchange = aplicarFiltros;
        }

        function aplicarFiltros() {
            const sistema = document.getElementById('fSistema').value;
            const uf = document.getElementById('fUF').value;
            const q = document.getElementById('fBuscar').value.toLowerCase();
            filteredItems = allItems.filter(i => {
                if (sistema && i.sistema !== sistema) return false;
                if (uf && i._uf !== uf) return false;
                const texto = `${i.item || ''} ${i.descripcion || ''}`.toLowerCase();
                if (q && !texto.includes(q)) return false;
                return true;
            });
            renderTabla();
            actualizarEstadisticas();
            renderDesglose();
        }

        function limpiarFiltros() {
            document.getElementById('fSistema').value = '';
            document.getElementById('fUF').value = '';
            document.getElementById('fBuscar').value = '';
            aplicarFiltros();
        }

        function num(val) { const n = parseFloat(String(val ?? '').toString().replace(/[^0-9.\-]/g, '')); return isNaN(n) ? 0 : n; }
        function fm(n, curr) {
            if (curr === 'USD') return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
            return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(n);
        }

        function renderTabla() {
            const tbody = document.getElementById('tbodyPresupuesto');
            if (filteredItems.length === 0) { tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#6c757d; padding: 14px;">Sin resultados</td></tr>'; return; }
            tbody.innerHTML = filteredItems.map(i => {
                const cantidad = num(i.cantidad);
                const vuUSD = num(i.vu);
                const totalUSD = cantidad * vuUSD;
                const vuCOP = num(i.vuCOP);
                const totalCOP = num(i.totalCOP) || (cantidad * vuCOP);
                const ufBadge = i._uf && i._uf !== 'N/A' ? `<span class="badge" style="background: #e3f2fd; color: #1976d2;">${i._uf}</span>` : '<span style="color: #999;">N/A</span>';
                return `
                    <tr>
                        <td>${i.item || ''}</td>
                        <td>${i.descripcion || ''}</td>
                        <td><span class="badge badge-sistema">${i.sistema || ''}</span></td>
                        <td class="right">${cantidad || 0}</td>
                        <td>${i.unidad || ''}</td>
                        <td>${i._tipoCalc || ''}</td>
                        <td style="text-align: center;">${ufBadge}</td>
                        <td class="right">${vuUSD ? fm(vuUSD, 'USD') : '-'}</td>
                        <td class="right">${totalUSD ? fm(totalUSD, 'USD') : '-'}</td>
                        <td class="right">${vuCOP ? fm(vuCOP, 'COP') : '-'}</td>
                        <td class="right">${totalCOP ? fm(totalCOP, 'COP') : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function getChapterNamesFromWBS(all) {
            const names = {};
            // Permitir overrides externos opcionales
            const overrides = (window && window.TM01_CAPITULO_NOMBRES) ? window.TM01_CAPITULO_NOMBRES : {};
            // Mapeo legible por defecto (fallback)
            const defaults = {
                '1': '1. CONTROL Y SEÑ‘ALIZACIÑ“N VIRTUAL',
                '2': '2. TELECOMUNICACIONES COLOCALIZADAS',
                '3': '3. SISTEMAS ITS Y SEGURIDAD',
                '4': '4. PASOS A NIVEL',
                '5': '5. CENTRO DE CONTROL OPERACIONAL',
                '6': '6. MATERIAL RODANTE'
            };
            // Inicializar capítulos presentes
            all.forEach(i => {
                const cap = String((i.item || '').split('.')[0] || '').trim();
                if (!cap) return;
                if (!names[cap]) names[cap] = cap; // placeholder
            });
            // Enriquecer con ítems de nivel 1 (capítulos) cuando existan
            const level1 = all.filter(i => (i.nivel === 1 || (i.item && i.item.indexOf('.') === -1)) && i.descripcion);
            level1.forEach(i => {
                const cap = String(i.item || '').split('.')[0];
                if (cap) names[cap] = `${cap}. ${i.descripcion}`;
            });
            // Si no hay nivel 1, derivar por sistema predominante dentro del capítulo
            Object.keys(names).forEach(cap => {
                if (overrides[cap]) { names[cap] = `${cap}. ${overrides[cap]}`; return; }
                if (names[cap] !== cap) return; // ya definido por nivel 1
                // Buscar items del capítulo y contar sistemas
                const itemsCap = all.filter(i => String((i.item || '').split('.')[0]) === cap);
                const freq = {};
                itemsCap.forEach(i => { const s = (i.sistema || '').trim(); if (!s) return; freq[s] = (freq[s] || 0) + 1; });
                const dominante = Object.keys(freq).sort((a,b)=>freq[b]-freq[a])[0];
                if (dominante) {
                    names[cap] = `${cap}. ${dominante}`;
                } else {
                    names[cap] = defaults[cap] || `Capítulo ${cap}`;
                }
            });
            return names;
        }

        function renderDesglose() {
            const tbody = document.getElementById('tbodyDesglose');
            const calc = calcularAIUIVA(filteredItems);
            const names = getChapterNamesFromWBS(allItems);
            const rows = [];
            Object.keys(calc.subtotales).sort().forEach(cap => {
                const c = calc.subtotales[cap];
                const cd = c.SUMINISTRO + c.OBRA + c.SERVICIO;
                const aiu = c.OBRA * 0.33;
                const ivaSum = c.SUMINISTRO * 0.19;
                const ivaServ = c.SERVICIO * 0.19;
                const ivaUtil = c.OBRA * 0.05 * 0.19;
                const iva = ivaSum + ivaServ + ivaUtil;
                const total = cd + aiu + iva;
                rows.push(`
                    <tr>
                        <td><strong>${names[cap] || cap}</strong></td>
                        <td class="right">${fm(c.SUMINISTRO, 'COP')}</td>
                        <td class="right">${fm(c.OBRA, 'COP')}</td>
                        <td class="right">${fm(c.SERVICIO, 'COP')}</td>
                        <td class="right"><strong>${fm(cd, 'COP')}</strong></td>
                        <td class="right">${fm(aiu, 'COP')}</td>
                        <td class="right">${fm(iva, 'COP')}</td>
                        <td class="right"><strong style="color:#1976d2;">${fm(total, 'COP')}</strong></td>
                        <td class="right"><strong>${fm(total/4400, 'USD')}</strong></td>
                    </tr>
                `);
                // Subfilas como en el ejemplo
                rows.push(`
                    <tr><td style="padding-left:30px;color:#004085;">←³ IVA Suministros (19%)</td><td></td><td></td><td></td><td></td><td></td><td class="right">${fm(ivaSum,'COP')}</td><td></td><td class="right">${fm(ivaSum/4400,'USD')}</td></tr>
                `);
                rows.push(`
                    <tr><td style="padding-left:30px;color:#004085;">←³ IVA Servicios (19%)</td><td></td><td></td><td></td><td></td><td></td><td class="right">${fm(ivaServ,'COP')}</td><td></td><td class="right">${fm(ivaServ/4400,'USD')}</td></tr>
                `);
                rows.push(`
                    <tr><td style="padding-left:30px;color:#004085;">←³ IVA/Utilidad Obra (19% × 5%)</td><td></td><td></td><td></td><td></td><td></td><td class="right">${fm(ivaUtil,'COP')}</td><td></td><td class="right">${fm(ivaUtil/4400,'USD')}</td></tr>
                `);
                if (c.OBRA > 0) {
                    rows.push(`
                        <tr><td style="padding-left:30px;color:#6c757d;">←³ Administración (23%)</td><td></td><td></td><td></td><td></td><td class="right">${fm(c.OBRA*0.23,'COP')}</td><td></td><td></td><td class="right">${fm((c.OBRA*0.23)/4400,'USD')}</td></tr>
                    `);
                    rows.push(`
                        <tr><td style="padding-left:30px;color:#6c757d;">←³ Imprevistos (5%)</td><td></td><td></td><td></td><td></td><td class="right">${fm(c.OBRA*0.05,'COP')}</td><td></td><td></td><td class="right">${fm((c.OBRA*0.05)/4400,'USD')}</td></tr>
                    `);
                    rows.push(`
                        <tr><td style="padding-left:30px;color:#6c757d;">←³ Utilidad (5%)</td><td></td><td></td><td></td><td></td><td class="right">${fm(c.OBRA*0.05,'COP')}</td><td></td><td></td><td class="right">${fm((c.OBRA*0.05)/4400,'USD')}</td></tr>
                    `);
                }
            });
            // Totales
            rows.push(`
                <tr style="font-weight:700;background:#e3f2fd;border-top:2px solid #1976d2;">
                    <td><strong>TOTAL GENERAL</strong></td>
                    <td class="right">${fm(calc.totalSuministros,'COP')}</td>
                    <td class="right">${fm(calc.totalObraCivil,'COP')}</td>
                    <td class="right">${fm(calc.totalServicios,'COP')}</td>
                    <td class="right">${fm(calc.costoDirecto,'COP')}</td>
                    <td class="right">${fm(calc.aiu,'COP')}</td>
                    <td class="right">${fm(calc.iva,'COP')}</td>
                    <td class="right" style="background:#d4edda;color:#155724;">${fm(calc.total,'COP')}</td>
                    <td class="right" style="background:#d4edda;color:#155724;">${fm(calc.total/4400,'USD')}</td>
                </tr>
            `);
            tbody.innerHTML = rows.join('');
        }

        function calcularAIUIVA(data) {
            // Suma por capítulo y por tipo SUM/OBRA/SERV
            const subtotales = {}; // { cap: { SUMINISTRO, OBRA, SERVICIO, ... } }
            let totalSuministros = 0, totalObraCivil = 0, totalServicios = 0;
            data.forEach(i => {
                const cap = String((i.item || '').split('.')[0] || '').trim() || 'OTROS';
                if (!subtotales[cap]) subtotales[cap] = { SUMINISTRO: 0, OBRA: 0, SERVICIO: 0 };
                const cantidad = num(i.cantidad);
                const totalCOP = num(i.totalCOP) || (cantidad * num(i.vuCOP));
                const tipo = i._tipoCalc || 'SUMINISTRO';
                subtotales[cap][tipo] += totalCOP;
                if (tipo === 'SUMINISTRO') totalSuministros += totalCOP;
                if (tipo === 'OBRA') totalObraCivil += totalCOP;
                if (tipo === 'SERVICIO') totalServicios += totalCOP;
            });
            // CD = SUM + OBRA + SERV
            const costoDirecto = totalSuministros + totalObraCivil + totalServicios;
            // AIU = 33% de OBRA (Adm 23% + Imp 5% + Util 5%)
            const aiu = totalObraCivil * 0.33;
            // IVA = 19% SUM + 19% SERV + 19% (5% de OBRA)
            const iva = (totalSuministros * 0.19) + (totalServicios * 0.19) + (totalObraCivil * 0.05 * 0.19);
            const total = costoDirecto + aiu + iva;
            return {
                costoDirecto,
                aiu,
                iva,
                total,
                totalSuministros,
                totalObraCivil,
                totalServicios,
                subtotales
            };
        }

        function actualizarEstadisticas() {
            const totUSD = filteredItems.reduce((s, i) => s + (num(i.cantidad) * num(i.vu)), 0);
            const totCOP = filteredItems.reduce((s, i) => s + (num(i.totalCOP) || (num(i.cantidad) * num(i.vuCOP))), 0);
            const calc = calcularAIUIVA(filteredItems);
            const nSum = filteredItems.filter(i => (i._tipoCalc === 'SUMINISTRO')).length;
            const nObra = filteredItems.filter(i => (i._tipoCalc === 'OBRA')).length;
            const nServ = filteredItems.filter(i => (i._tipoCalc === 'SERVICIO')).length;
            document.getElementById('statUSD').textContent = fm(totUSD, 'USD');
            document.getElementById('statCOP').textContent = fm(totCOP, 'COP');
            document.getElementById('statAIU').textContent = fm(calc.aiu, 'COP');
            document.getElementById('statIVA').textContent = fm(calc.iva, 'COP');
            document.getElementById('statItems').textContent = String(filteredItems.length);
            document.getElementById('statSum').textContent = String(nSum);
            document.getElementById('statObra').textContent = String(nObra);
            document.getElementById('statServ').textContent = String(nServ);
        }

        function exportarExcel() {
            if (filteredItems.length === 0) { alert('No hay datos para exportar'); return; }
            const rows = filteredItems.map(i => ({
                Item: i.item || '',
                Descripción: i.descripcion || '',
                Sistema: i.sistema || '',
                Tipo: i._tipoCalc || '',
                Cantidad: num(i.cantidad),
                Unidad: i.unidad || '',
                'VU USD': num(i.vu),
                'Total USD': num(i.cantidad) * num(i.vu),
                'VU COP': num(i.vuCOP),
                'Total COP': num(i.totalCOP) || (num(i.cantidad) * num(i.vuCOP))
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'WBS Presupuesto');
            XLSX.writeFile(wb, 'WBS_Presupuesto_TM01.xlsx');
        }

        function exportarDesgloseAIU() {
            if (filteredItems.length === 0) { alert('No hay datos para exportar'); return; }
            const calc = calcularAIUIVA(filteredItems);
            const names = getChapterNamesFromWBS(allItems);

            // Preparar datos estructurados por capítulo para usar en la vista previa y en la exportación
            const caps = Object.keys(calc.subtotales).sort().map(cap => {
                const c = calc.subtotales[cap];
                const cd = c.SUMINISTRO + c.OBRA + c.SERVICIO;
                const aiu = c.OBRA * 0.33;
                const ivaSum = c.SUMINISTRO * 0.19;
                const ivaServ = c.SERVICIO * 0.19;
                const ivaUtil = c.OBRA * 0.05 * 0.19;
                const iva = ivaSum + ivaServ + ivaUtil;
                const total = cd + aiu + iva;
                return {
                    cap,
                    capName: names[cap] || cap,
                    SUMINISTRO: c.SUMINISTRO,
                    OBRA: c.OBRA,
                    SERVICIO: c.SERVICIO,
                    cd, aiu, iva, total,
                    ivaSum, ivaServ, ivaUtil
                };
            });

            // Abrir vista previa
            const w = window.open('', '_blank');
            const style = `body{font-family:Segoe UI,Tahoma,Verdana,sans-serif;background:#f7f9fc;color:#111;margin:0;padding:16px}
            .wrap{max-width:1200px;margin:0 auto;background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
            .hdr{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;background:#0ea5e9;color:#fff}
            .hdr h1{margin:0;font-size:18px}
            .sub{padding:10px 18px;background:#ecfeff;color:#0369a1;font-size:13px}
            .tools{display:flex;gap:8px}
            .btn{padding:8px 12px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
            .btn-print{background:#1f2937;color:#fff}
            .btn-xlsx{background:#22c55e;color:#fff}
            table{border-collapse:collapse;width:100%;font-size:13px}
            thead th{position:sticky;top:0;background:#0f172a;color:#fff}
            th,td{border:1px solid #e5e7eb;padding:10px;text-align:right}
            th:first-child,td:first-child{text-align:left}
            .row-sub td{color:#0369a1;background:#f0f9ff}
            .row-sub-obra td{color:#6b7280;background:#fff7ed}
            .row-total td{font-weight:700;background:#f8fafc}
            `;

            const header = `
                <div class="hdr">
                    <h1>📊 DESGLOSE PRESUPUESTAL POR CAPÑTULOS</h1>
                    <div class="tools">
                        <button class="btn btn-print" onclick="window.print()">🖨️ Imprimir</button>
                        <button class="btn btn-xlsx" onclick="exportarDesdePreview()">📊 Exportar Desglose a Excel</button>
                    </div>
                </div>
                <div class="sub">✅ WBS Actualizada - Cálculo: AIU 33% solo OBRA; IVA 19% a SUM+SERV + 19% a Utilidad de OBRA (5%).</div>
            `;

            const tableHead = `
                <table>
                    <thead>
                        <tr>
                            <th>CAPÑTULO</th>
                            <th>SUMINISTROS (COP)</th>
                            <th>OBRA CIVIL (COP)</th>
                            <th>SERVICIOS (COP)</th>
                            <th>COSTO DIRECTO (COP)</th>
                            <th>AIU 33% (COP)</th>
                            <th>IVA (COP)</th>
                            <th>TOTAL (COP)</th>
                            <th>TOTAL (USD)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const rows = caps.map(c => {
                const usd = c.total / 4400;
                return `
                    <tr>
                        <td>${c.capName}</td>
                        <td>${fm(c.SUMINISTRO,'COP')}</td>
                        <td>${fm(c.OBRA,'COP')}</td>
                        <td>${fm(c.SERVICIO,'COP')}</td>
                        <td>${fm(c.cd,'COP')}</td>
                        <td>${fm(c.aiu,'COP')}</td>
                        <td>${fm(c.iva,'COP')}</td>
                        <td>${fm(c.total,'COP')}</td>
                        <td>${fm(usd,'USD')}</td>
                    </tr>
                    <tr class="row-sub">
                        <td>←³ IVA Suministros (19%)</td>
                        <td></td><td></td><td></td><td></td><td></td>
                        <td>${fm(c.ivaSum,'COP')}</td>
                        <td></td>
                        <td>${fm(c.ivaSum/4400,'USD')}</td>
                    </tr>
                    <tr class="row-sub">
                        <td>←³ IVA Servicios (19%)</td>
                        <td></td><td></td><td></td><td></td><td></td>
                        <td>${fm(c.ivaServ,'COP')}</td>
                        <td></td>
                        <td>${fm(c.ivaServ/4400,'USD')}</td>
                    </tr>
                    <tr class="row-sub">
                        <td>←³ IVA/Utilidad Obra (19% × 5%)</td>
                        <td></td><td></td><td></td><td></td><td></td>
                        <td>${fm(c.ivaUtil,'COP')}</td>
                        <td></td>
                        <td>${fm(c.ivaUtil/4400,'USD')}</td>
                    </tr>
                    ${c.OBRA>0 ? `
                    <tr class="row-sub-obra"><td>←³ Administración (23%)</td><td></td><td>${fm(c.OBRA*0.23,'COP')}</td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr class="row-sub-obra"><td>←³ Imprevistos (5%)</td><td></td><td>${fm(c.OBRA*0.05,'COP')}</td><td></td><td></td><td></td><td></td><td></td></tr>
                    <tr class="row-sub-obra"><td>←³ Utilidad (5%)</td><td></td><td>${fm(c.OBRA*0.05,'COP')}</td><td></td><td></td><td></td><td></td><td></td></tr>
                    `: ''}
                `;
            }).join('');

            const totalRow = `
                <tr class="row-total">
                    <td>TOTAL GENERAL</td>
                    <td>${fm(calc.totalSuministros,'COP')}</td>
                    <td>${fm(calc.totalObraCivil,'COP')}</td>
                    <td>${fm(calc.totalServicios,'COP')}</td>
                    <td>${fm(calc.costoDirecto,'COP')}</td>
                    <td>${fm(calc.aiu,'COP')}</td>
                    <td>${fm(calc.iva,'COP')}</td>
                    <td>${fm(calc.total,'COP')}</td>
                    <td>${fm(calc.total/4400,'USD')}</td>
                </tr>
            `;

            const end = `</tbody></table>`;

            const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Desglose AIU - TM01</title>
                <style>${style}</style>
                <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"><\/script>
            </head><body>
                <div class="wrap">${header}
                    <div style="padding:16px 18px;">${tableHead}${rows}${totalRow}${end}</div>
                </div>
                <script>
                    const capsData = ${JSON.stringify(caps)};
                    const totales = ${JSON.stringify({
                        totalSuministros: calc.totalSuministros,
                        totalObraCivil: calc.totalObraCivil,
                        totalServicios: calc.totalServicios,
                        costoDirecto: calc.costoDirecto,
                        aiu: calc.aiu,
                        iva: calc.iva,
                        total: calc.total
                    })};
                    function exportarDesdePreview(){
                        const data = [
                            ['DESGLOSE PRESUPUESTAL POR CAPÑTULOS - TM01'],
                            ['Fecha', new Date().toLocaleDateString('es-CO')],
                            [],
                            ['CAPÑTULO','SUMINISTROS (COP)','OBRA CIVIL (COP)','SERVICIOS (COP)','COSTO DIRECTO (COP)','AIU 33% (COP)','IVA (COP)','TOTAL (COP)','TOTAL (USD)']
                        ];
                        capsData.forEach(c=>{
                            data.push([c.capName,c.SUMINISTRO,c.OBRA,c.SERVICIO,c.cd,c.aiu,c.iva,c.total,c.total/4400]);
                            data.push(['', '←³ Administración (23%)', '', '', '', c.OBRA*0.23, '', '', (c.OBRA*0.23)/4400]);
                            data.push(['', '←³ Imprevistos (5%)', '', '', '', c.OBRA*0.05, '', '', (c.OBRA*0.05)/4400]);
                            data.push(['', '←³ Utilidad (5%)', '', '', '', c.OBRA*0.05, '', '', (c.OBRA*0.05)/4400]);
                            data.push(['', '←³ IVA Suministros (19%)', '', '', '', c.ivaSum, '', '', (c.ivaSum)/4400]);
                            data.push(['', '←³ IVA Servicios (19%)', '', '', '', c.ivaServ, '', '', (c.ivaServ)/4400]);
                            data.push(['', '←³ IVA/Utilidad Obra (19%×5%)', '', '', '', c.ivaUtil, '', '', (c.ivaUtil)/4400]);
                        });
                        data.push([]);
                        data.push(['TOTAL GENERAL', totales.totalSuministros, totales.totalObraCivil, totales.totalServicios, totales.costoDirecto, totales.aiu, totales.iva, totales.total, totales.total/4400]);
                        const ws = XLSX.utils.aoa_to_sheet(data);
                        ws['!cols'] = [ {wch:40},{wch:24},{wch:20},{wch:20},{wch:22},{wch:18},{wch:16},{wch:20},{wch:16} ];
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'Desglose AIU');
                        const fname = 'Desglose_AIU_TM01_' + new Date().toISOString().split('T')[0] + '.xlsx';
                        XLSX.writeFile(wb, fname);
                    }
                <\/script>
            </body></html>`;
            w.document.write(html);
            w.document.close();
        }

        function generarActaObra() {
            const calc = calcularAIUIVA(filteredItems);
            const names = getChapterNamesFromWBS(allItems);
            const w = window.open('', '_blank');
            const fmtCOP = (n) => fm(n, 'COP');
            const fmtUSD = (n) => fm(n, 'USD');
            const toUSD = (n) => (n / 4400);

            const capitulos = {};
            filteredItems.forEach(i => {
                const cap = String((i.item || '').split('.')[0] || '').trim() || 'OTROS';
                if (!capitulos[cap]) capitulos[cap] = { SUMINISTRO: [], OBRA: [], SERVICIO: [] };
                const cantidad = num(i.cantidad);
                const vuCOP = num(i.vuCOP);
                const totalCOP = num(i.totalCOP) || (cantidad * vuCOP);
                const tipo = i._tipoCalc || 'SUMINISTRO';
                capitulos[cap][tipo].push({
                    codigo: i.item || '', descripcion: i.descripcion || '', tipo,
                    unidad: i.unidad || '', cantidad, vuCOP, totalCOP, totalUSD: toUSD(totalCOP)
                });
            });

            const estilo = `
                body{font-family:Segoe UI,Tahoma,Verdana,sans-serif;background:#f2f5fb;color:#0f172a;margin:0}
                .wrap{max-width:1280px;margin:0 auto}
                .hero{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:40px 24px;border-radius:12px;margin:16px}
                .toolbar{position:sticky;top:0;z-index:10;display:flex;gap:10px;justify-content:flex-end;margin:0 16px}
                .btn{padding:10px 16px;border:none;border-radius:8px;font-weight:700;cursor:pointer}
                .btn-print{background:#1d4ed8;color:#fff}
                .btn-excel{background:#22c55e;color:#fff}
                h1{margin:0 0 8px;font-size:36px}
                h2{background:#183a66;color:#fff;padding:14px 18px;border-radius:10px;margin:24px 16px 12px}
                h3{margin:16px 16px 8px;color:#0f172a}
                table{border-collapse:collapse;width:calc(100% - 32px);margin:0 16px 14px;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.06)}
                thead th{background:#0f172a;color:#fff}
                th,td{border:1px solid #e5e7eb;padding:10px;font-size:13px;text-align:right}
                th:first-child,td:first-child{text-align:left}
                tfoot th{background:#f8fafc}
                .row-subtotal th{background:#eef2ff;font-weight:700}
                .row-highlight td{background:#fff3cd}
                .row-iva td{background:#e6f4ff;color:#0b5394}
                .row-aiu td{background:#fff8e1}
                .row-total td{background:#e6ffed;font-weight:800}
                .mini td{font-size:12px}
                .pill{display:inline-block;background:#0ea5e9;color:#fff;padding:2px 8px;border-radius:999px;font-size:12px;margin-left:8px}
            `;

            const tablaItems = (titulo, lista, estiloExtra='') => {
                if (!lista || lista.length === 0) return '';
                const filas = lista.map(it => `
                    <tr>
                        <td>${it.codigo}</td><td>${it.descripcion}</td><td>${it.tipo}</td><td>${it.unidad}</td>
                        <td style=\"text-align:right;\">${it.cantidad}</td>
                        <td style=\"text-align:right;\">${fmtCOP(it.vuCOP)}</td>
                        <td style=\"text-align:right;\">${fmtCOP(it.totalCOP)}</td>
                        <td style=\"text-align:right;\">${fmtUSD(it.totalUSD)}</td>
                    </tr>`).join('');
                const subtotalCOP = lista.reduce((s, it) => s + it.totalCOP, 0);
                const subtotalUSD = toUSD(subtotalCOP);
                return `
                    <h3>${titulo}</h3>
                    <table class=\"t ${estiloExtra}\"><thead><tr>
                        <th>ÑTEM</th><th>DESCRIPCIÑ“N</th><th>TIPO</th><th>UNIDAD</th><th>CANTIDAD</th><th>VU (COP)</th><th>TOTAL (COP)</th><th>TOTAL (USD)</th>
                    </tr></thead><tbody>${filas}</tbody>
                    <tfoot><tr class=\"row-subtotal\"><th colspan=\"6\" style=\"text-align:right;\">SUBTOTAL ${titulo.toUpperCase()}:</th><th>${fmtCOP(subtotalCOP)}</th><th>${fmtUSD(subtotalUSD)}</th></tr></tfoot></table>`;
            };

            const secciones = Object.keys(capitulos).sort().map(cap => {
                const listas = capitulos[cap];
                const sumCOP = listas.SUMINISTRO.reduce((s, it) => s + it.totalCOP, 0);
                const obraCOP = listas.OBRA.reduce((s, it) => s + it.totalCOP, 0);
                const servCOP = listas.SERVICIO.reduce((s, it) => s + it.totalCOP, 0);
                const cd = sumCOP + obraCOP + servCOP;
                const adm = obraCOP * 0.23, imp = obraCOP * 0.05, uti = obraCOP * 0.05, aiu = adm + imp + uti;
                const ivaSum = sumCOP * 0.19, ivaServ = servCOP * 0.19, ivaUtil = obraCOP * 0.05 * 0.19, iva = ivaSum + ivaServ + ivaUtil;
                const total = cd + aiu + iva;
                return `
                    <h2>${names[cap] || ('Capítulo '+cap)}</h2>
                    ${tablaItems('1.1 SUMINISTROS', listas.SUMINISTRO)}
                    ${sumCOP>0?`<table class=\"t mini\"><tbody>
                        <tr class=\"row-iva\"><td>IVA 19% (Solo aplica a SUMINISTROS)</td><td style=\"text-align:right;\">${fmtCOP(ivaSum)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(ivaSum))}</td></tr>
                        <tr class=\"row-total\"><td>TOTAL SUMINISTROS (con IVA)</td><td style=\"text-align:right;\">${fmtCOP(sumCOP+ivaSum)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(sumCOP+ivaSum))}</td></tr>
                    </tbody></table>`:''}
                    ${tablaItems('2.2 OBRA CIVIL', listas.OBRA, 'mini')}
                    ${obraCOP>0?`<table class=\"t mini\"><tbody>
                        <tr class=\"row-aiu\"><td>Administración (23%)</td><td style=\"text-align:right;\">${fmtCOP(adm)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(adm))}</td></tr>
                        <tr class=\"row-aiu\"><td>Imprevistos (5%)</td><td style=\"text-align:right;\">${fmtCOP(imp)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(imp))}</td></tr>
                        <tr class=\"row-aiu\"><td>Utilidad (5%)</td><td style=\"text-align:right;\">${fmtCOP(uti)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(uti))}</td></tr>
                        <tr class=\"row-highlight\"><td><strong>AIU Total (33%)</strong></td><td style=\"text-align:right;\"><strong>${fmtCOP(aiu)}</strong></td><td style=\"text-align:right;\"><strong>${fmtUSD(toUSD(aiu))}</strong></td></tr>
                        <tr class=\"row-iva\"><td>IVA/Utilidad (19% × 5%)</td><td style=\"text-align:right;\">${fmtCOP(ivaUtil)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(ivaUtil))}</td></tr>
                        <tr class=\"row-total\"><td>TOTAL OBRA CIVIL (con AIU + IVA)</td><td style=\"text-align:right;\">${fmtCOP(obraCOP+aiu+ivaUtil)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(obraCOP+aiu+ivaUtil))}</td></tr>
                    </tbody></table>`:''}
                    ${tablaItems('3.3 SERVICIOS', listas.SERVICIO)}
                    <table class=\"t mini\"><tbody>
                        <tr class=\"row-iva\"><td>IVA Suministros (19%)</td><td style=\"text-align:right;\">${fmtCOP(ivaSum)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(ivaSum))}</td></tr>
                        <tr class=\"row-iva\"><td>IVA Servicios (19%)</td><td style=\"text-align:right;\">${fmtCOP(ivaServ)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(ivaServ))}</td></tr>
                        <tr class=\"row-iva\"><td>IVA/Utilidad Obra (19% × 5%)</td><td style=\"text-align:right;\">${fmtCOP(ivaUtil)}</td><td style=\"text-align:right;\">${fmtUSD(toUSD(ivaUtil))}</td></tr>
                        <tr class=\"row-total\"><td><strong>TOTAL ${names[cap] || ('Capítulo '+cap)}</strong></td><td style=\"text-align:right;\"><strong>${fmtCOP(total)}</strong></td><td style=\"text-align:right;\"><strong>${fmtUSD(toUSD(total))}</strong></td></tr>
                    </tbody></table>
                `;
            }).join('');

            const html = `<!DOCTYPE html><html><head><meta=\"UTF-8\"><title>ACTA DE OBRA - TM01</title>
                <style>${estilo}</style>
                <script src=\"https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js\"><\/script>
            </head><body>
                <div class=\"toolbar\"><button class=\"btn btn-print\" onclick=\"window.print()\">🖨️ Imprimir</button><button class=\"btn btn-excel\" onclick=\"exportarActaExcel()\">📊 Exportar Excel</button></div>
                <div class=\"hero\"><div class=\"wrap\">
                    <h1>📝 ACTA DE OBRA</h1>
                    <div style=\"font-size:22px;margin-top:6px;\">WBS - Sistema de Comunicaciones y Control<span class=\"pill\">UF-2.2 | v3.0</span></div>
                    <div style=\"margin-top:12px;opacity:.95\">Fecha: ${new Date().toLocaleDateString('es-CO')}</div>
                </div></div>
                <div class=\"wrap\">${secciones}</div>
                <script>
                    const capsResumen = ${JSON.stringify(Object.keys(capitulos).sort().map(cap=>{
                        const listas = capitulos[cap];
                        const sum = listas.SUMINISTRO.reduce((s,it)=>s+it.totalCOP,0);
                        const obra = listas.OBRA.reduce((s,it)=>s+it.totalCOP,0);
                        const serv = listas.SERVICIO.reduce((s,it)=>s+it.totalCOP,0);
                        const cd = sum+obra+serv; const aiu = obra*0.33; const iva = (sum*0.19)+(serv*0.19)+(obra*0.05*0.19);
                        return { cap: cap, name: (names && names[cap]) || ('Capítulo '+cap), sum, obra, serv, cd, aiu, iva, total: cd+aiu+iva };
                    }))};
                    function exportarActaExcel(){
                        const data = [['ACTA DE OBRA - TM01'],['Fecha', new Date().toLocaleDateString('es-CO')],[],['CAPÑTULO','SUM (COP)','OBRA (COP)','SERV (COP)','CD (COP)','AIU 33% (COP)','IVA (COP)','TOTAL (COP)','TOTAL (USD)']];
                        capsResumen.forEach(c=>{ data.push([c.name,c.sum,c.obra,c.serv,c.cd,c.aiu,c.iva,c.total,c.total/4400]); });
                        const ws = XLSX.utils.aoa_to_sheet(data); ws['!cols']=[{wch:40},{wch:18},{wch:18},{wch:18},{wch:18},{wch:16},{wch:16},{wch:18},{wch:16}];
                        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Acta de Obra');
                        const fname = 'Acta_Obra_TM01_' + new Date().toISOString().split('T')[0] + '.xlsx';
                        XLSX.writeFile(wb, fname);
                    }
                <\/script>
            </body></html>`;
            w.document.write(html);
            w.document.close();
        }

        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', waitForDataAndInit); } else { waitForDataAndInit(); }
    </script>
</body>
</html>



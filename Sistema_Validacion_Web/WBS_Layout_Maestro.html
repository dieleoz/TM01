<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBS Layout Maestro - TM01 Troncal Magdalena</title>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .status-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #495057;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .map-container {
            height: 600px;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .stats-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
        }
        
        .stats-panel h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .legend h3 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .table-container {
            padding: 20px 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .table-container th,
        .table-container td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .table-container th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }
        
        .table-container tr:hover {
            background: #f8f9fa;
        }
        
        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            border-top: 1px solid #e9ecef;
        }
        
        .back-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
        }
        
        .back-button:hover {
            background: #5a6fd8;
        }
        
        .icon {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è WBS LAYOUT MAESTRO INTERACTIVO v14.7</h1>
            <p>Proyecto TM01 Troncal Magdalena | 2,182 Equipos e Infraestructura</p>
            <div class="status-bar">
                <span class="status-item">‚úÖ 1,823 Cajas Fibra</span>
                <span class="status-item">‚úÖ 130 Domos Fusi√≥n</span>
                <span class="status-item">‚úÖ 37 TETRA</span>
                <span class="status-item">‚úÖ 20 CTC</span>
                <span class="status-item">‚úÖ 57 CCTV</span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="exportarExcel()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20"><path d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"/></svg>
                Exportar a Excel
            </button>
            <button class="btn btn-secondary" onclick="generarDTLayout()">
                <svg class="icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0113 3.414L16.586 7A2 2 0 0118 8.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2-1a1 1 0 00-1 1v12a1 1 0 001 1h10a1 1 0 001-1V8.414a1 1 0 00-.293-.707L12.707 3.293A1 1 0 0012 3H6z" clip-rule="evenodd"/></svg>
                Generar DT desde Filtro
            </button>
            
            <div class="filter-group">
                <label for="filtroTipo">Filtrar por Tipo:</label>
                <select id="filtroTipo" onchange="filtrarLayout()">
                    <option value="TODOS">Todos</option>
                    <option value="SOS">Postes SOS</option>
                    <option value="CCTV">CCTV</option>
                    <option value="PMV">PMV</option>
                    <option value="RADAR-ANPR">RADAR-ANPR</option>
                    <option value="ETD">ETD</option>
                    <option value="GALIBO">G√°libo</option>
                    <option value="METEO">Estaciones Meteorol√≥gicas</option>
                    <option value="WIM">WIM</option>
                    <option value="PEAJE">Peajes</option>
                    <option value="AS">√Åreas de Servicio</option>
                    <option value="CCO">CCO</option>
                    <option value="CAJA_FO">Cajas de Fibra</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="filtroUF">Filtrar por UF:</label>
                <select id="filtroUF" onchange="filtrarLayout()">
                    <option value="TODOS">Todos</option>
                    <option value="0D">UF 0D</option>
                    <option value="1">UF 1</option>
                    <option value="2">UF 2</option>
                    <option value="3">UF 3</option>
                    <option value="4">UF 4</option>
                    <option value="5">UF 5</option>
                    <option value="5.1">UF 5.1</option>
                    <option value="5.2">UF 5.2</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="filtroVia">Filtrar por V√≠a:</label>
                <select id="filtroVia" onchange="filtrarLayout()">
                    <option value="TODOS">Todos</option>
                    <option value="Izquierda">Calzada Izquierda</option>
                    <option value="Derecha">Calzada Derecha</option>
                    <option value="Separador">Separador Central</option>
                    <option value="Unidireccional">Unidireccional</option>
                </select>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            
            <div class="stats-panel">
                <h3>üìä Estad√≠sticas</h3>
                <div class="stat-item">
                    <span>Total Equipos:</span>
                    <span id="totalEquipos">0</span>
                </div>
                <div class="stat-item">
                    <span>SOS:</span>
                    <span id="totalSOS">0</span>
                </div>
                <div class="stat-item">
                    <span>CCTV:</span>
                    <span id="totalCCTV">0</span>
                </div>
                <div class="stat-item">
                    <span>PMV:</span>
                    <span id="totalPMV">0</span>
                </div>
                <div class="stat-item">
                    <span>ETD/RADAR:</span>
                    <span id="totalETD">0</span>
                </div>
                <div class="stat-item">
                    <span>Longitud:</span>
                    <span>293 km</span>
                </div>
            </div>
            
            <div class="legend">
                <h3>üè∑Ô∏è Leyenda</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc3545;"></div>
                    <span>SOS</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #007bff;"></div>
                    <span>CCTV</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffc107;"></div>
                    <span>PMV</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fd7e14;"></div>
                    <span>ETD/RADAR</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #20c997;"></div>
                    <span>METEO</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #6f42c1;"></div>
                    <span>CCO</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #28a745;"></div>
                    <span>PEAJE</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #6c757d;"></div>
                    <span>FIBRA</span>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="layoutTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>RUTA</th>
                        <th>UF</th>
                        <th>V√çA</th>
                        <th>TIPO</th>
                        <th>SISTEMA</th>
                        <th>PKR</th>
                        <th>PKD</th>
                        <th>SEP_SOS</th>
                        <th>OBSERVACI√ìN</th>
                        <th>SWITCH_L2</th>
                        <th>SUB_ANILLO</th>
                        <th>NODO_L3</th>
                    </tr>
                </thead>
                <tbody id="layoutBody">
                    <!-- Data will be rendered here by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <button class="back-button" onclick="location.href='WBS_Menu_Principal.html'">‚Üê Volver al Men√∫ Principal</button>
        </div>
    </div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([6.9, -74.2], 8); // Centered roughly on Magdalena region

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Layout data based on the real project structure from 42_LAYOUT_GEORREFERENCIADO_EQUIPOS_ITS_v1.0.md
        const layoutData = [
            // UF 0D - CCO La Lizama PK 4+300
            { id: 1, ruta: "4510", uf: "0D", via: "Separador", tipo: "CCO", sistema: "CCO", pkr: "4+300", pkd: "4+300", sep_sos: "-", observacion: "Centro de Control Operacional", switch_l2: "L2-CCO", sub_anillo: "SA-CCO", nodo_l3: "N1-CCO", lat: 6.7, lon: -74.5 },
            
            // UF 0D - Postes SOS (Sistema "Tres Bolillos" - alternados)
            { id: 2, ruta: "4510", uf: "0D", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "41+180", pkd: "241+920", sep_sos: "0.00", observacion: "SOS #1", switch_l2: "L2-242", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.8, lon: -74.3 },
            { id: 3, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "43+560", pkd: "239+540", sep_sos: "2.38", observacion: "SOS #2", switch_l2: "L2-240", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.82, lon: -74.28 },
            { id: 4, ruta: "4510", uf: "0D", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "46+550", pkd: "236+550", sep_sos: "2.99", observacion: "SOS #3 - Peatonal 48+360", switch_l2: "L2-237", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.85, lon: -74.25 },
            { id: 5, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "49+550", pkd: "233+550", sep_sos: "3.00", observacion: "SOS #4", switch_l2: "L2-234", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.88, lon: -74.22 },
            { id: 6, ruta: "4510", uf: "0D", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "52+550", pkd: "230+550", sep_sos: "3.00", observacion: "SOS #5", switch_l2: "L2-231", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.91, lon: -74.19 },
            { id: 7, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "55+500", pkd: "227+600", sep_sos: "2.95", observacion: "SOS #6", switch_l2: "L2-228", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.94, lon: -74.16 },
            { id: 8, ruta: "4510", uf: "0D", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "58+500", pkd: "224+600", sep_sos: "3.00", observacion: "SOS #7", switch_l2: "L2-225", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.97, lon: -74.13 },
            { id: 9, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "61+500", pkd: "221+600", sep_sos: "3.00", observacion: "SOS #8", switch_l2: "L2-222", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 7.0, lon: -74.1 },
            { id: 10, ruta: "4510", uf: "0D", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "64+450", pkd: "218+650", sep_sos: "2.95", observacion: "SOS #9", switch_l2: "L2-219", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 7.03, lon: -74.07 },
            { id: 11, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "67+150", pkd: "215+950", sep_sos: "2.70", observacion: "SOS #10", switch_l2: "L2-216", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 7.06, lon: -74.04 },
            { id: 12, ruta: "4510", uf: "0D", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "70+150", pkd: "212+950", sep_sos: "3.00", observacion: "SOS #11", switch_l2: "L2-213", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.09, lon: -74.01 },
            
            // UF 0D - PMV (Paneles de Mensaje Variable)
            { id: 13, ruta: "4510", uf: "0D", via: "Derecha", tipo: "PMV", sistema: "PMV", pkr: "41+000", pkd: "242+100", sep_sos: "-", observacion: "Inter Koran 40+450", switch_l2: "L2-242", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.79, lon: -74.31 },
            { id: 14, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "PMV", sistema: "PMV", pkr: "41+200", pkd: "242+000", sep_sos: "-", observacion: "", switch_l2: "L2-242", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.81, lon: -74.29 },
            { id: 15, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "PMV", sistema: "PMV", pkr: "57+350", pkd: "225+750", sep_sos: "-", observacion: "Desde PMV anterior", switch_l2: "L2-226", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.95, lon: -74.12 },
            { id: 16, ruta: "4510", uf: "0D", via: "Derecha", tipo: "PMV", sistema: "PMV", pkr: "58+950", pkd: "224+150", sep_sos: "-", observacion: "Desde PMV anterior", switch_l2: "L2-224", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.98, lon: -74.09 },
            
            // UF 0D - CCTV (C√°maras de videovigilancia)
            { id: 17, ruta: "4510", uf: "0D", via: "Separador", tipo: "CCTV", sistema: "CCTV", pkr: "40+050", pkd: "243+150", sep_sos: "-", observacion: "Inter Koran - REACTIVADA", switch_l2: "L2-243", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.78, lon: -74.33 },
            { id: 18, ruta: "4510", uf: "0D", via: "Separador", tipo: "CCTV", sistema: "CCTV", pkr: "69+000", pkd: "214+100", sep_sos: "-", observacion: "Peatonal 68+434", switch_l2: "L2-214", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.95, lon: -74.1 },
            
            // UF 0D - RADAR-ANPR (Radares de reconocimiento de placas)
            { id: 19, ruta: "4510", uf: "0D", via: "Izquierda", tipo: "RADAR-ANPR", sistema: "RADAR-ANPR", pkr: "54+000", pkd: "229+100", sep_sos: "-", observacion: "Par bidireccional", switch_l2: "L2-229", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.9, lon: -74.15 },
            { id: 20, ruta: "4510", uf: "0D", via: "Derecha", tipo: "RADAR-ANPR", sistema: "RADAR-ANPR", pkr: "54+000", pkd: "229+100", sep_sos: "-", observacion: "Par bidireccional", switch_l2: "L2-229", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.9, lon: -74.15 },
            
            // UF 0D - G√°libo (Detector de altura)
            { id: 21, ruta: "4510", uf: "0D", via: "Derecha", tipo: "GALIBO", sistema: "G√ÅLIBO", pkr: "41+350", pkd: "241+750", sep_sos: "-", observacion: "Altura m√≠n 5.10m", switch_l2: "L2-242", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.8, lon: -74.3 },
            
            // UF 1 - Continuaci√≥n del corredor
            { id: 22, ruta: "4510", uf: "1", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "73+150", pkd: "209+950", sep_sos: "3.00", observacion: "SOS #12", switch_l2: "L2-210", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.12, lon: -73.98 },
            { id: 23, ruta: "4510", uf: "1", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "76+150", pkd: "206+950", sep_sos: "3.00", observacion: "SOS #13", switch_l2: "L2-207", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.15, lon: -73.95 },
            { id: 24, ruta: "4510", uf: "1", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "79+150", pkd: "203+950", sep_sos: "3.00", observacion: "SOS #14", switch_l2: "L2-204", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.18, lon: -73.92 },
            
            // UF 1 - PMV
            { id: 25, ruta: "4510", uf: "1", via: "Derecha", tipo: "PMV", sistema: "PMV", pkr: "75+000", pkd: "208+100", sep_sos: "-", observacion: "Desde PMV anterior", switch_l2: "L2-208", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.11, lon: -73.99 },
            
            // UF 1 - CCTV
            { id: 26, ruta: "4510", uf: "1", via: "Separador", tipo: "CCTV", sistema: "CCTV", pkr: "78+000", pkd: "205+100", sep_sos: "-", observacion: "Peatonal 77+434", switch_l2: "L2-205", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.16, lon: -73.94 },
            
            // UF 1 - Peaje Zambito
            { id: 27, ruta: "4510", uf: "1", via: "Separador", tipo: "PEAJE", sistema: "PEAJE", pkr: "75+500", pkd: "207+600", sep_sos: "-", observacion: "Peaje Zambito", switch_l2: "L2-208", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.11, lon: -73.99 },
            
            // UF 1 - √Årea de Servicio Zambito
            { id: 28, ruta: "4510", uf: "1", via: "Separador", tipo: "AS", sistema: "AS", pkr: "76+000", pkd: "207+100", sep_sos: "-", observacion: "√Årea de Servicio Zambito", switch_l2: "L2-207", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.12, lon: -73.98 },
            
            // UF 1 - Estaci√≥n Meteorol√≥gica Peaje Zambito
            { id: 29, ruta: "4510", uf: "1", via: "Separador", tipo: "METEO", sistema: "METEO", pkr: "75+500", pkd: "207+600", sep_sos: "-", observacion: "Estaci√≥n Meteorol√≥gica Peaje Zambito", switch_l2: "L2-208", sub_anillo: "SA4-B", nodo_l3: "N6-AS_ZAMBITO", lat: 7.11, lon: -73.99 },
            
            // UF 2 - Continuaci√≥n
            { id: 30, ruta: "4510", uf: "2", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "82+150", pkd: "200+950", sep_sos: "3.00", observacion: "SOS #15", switch_l2: "L2-201", sub_anillo: "SA4-A", nodo_l3: "N6-AS_ZAMBITO", lat: 7.21, lon: -73.89 },
            { id: 31, ruta: "4510", uf: "2", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "85+150", pkd: "197+950", sep_sos: "3.00", observacion: "SOS #16", switch_l2: "L2-198", sub_anillo: "SA4-A", nodo_l3: "N6-AS_ZAMBITO", lat: 7.24, lon: -73.86 },
            
            // UF 2 - WIM (B√°scula din√°mica)
            { id: 32, ruta: "4510", uf: "2", via: "Separador", tipo: "WIM", sistema: "WIM", pkr: "85+000", pkd: "198+100", sep_sos: "-", observacion: "B√°scula Din√°mica", switch_l2: "L2-198", sub_anillo: "SA4-A", nodo_l3: "N6-AS_ZAMBITO", lat: 7.23, lon: -73.87 },
            
            // UF 3 - Continuaci√≥n
            { id: 33, ruta: "4510", uf: "3", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "88+150", pkd: "194+950", sep_sos: "3.00", observacion: "SOS #17", switch_l2: "L2-195", sub_anillo: "SA3-B", nodo_l3: "N5-BUNKER01", lat: 7.27, lon: -73.83 },
            { id: 34, ruta: "4510", uf: "3", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "91+150", pkd: "191+950", sep_sos: "3.00", observacion: "SOS #18", switch_l2: "L2-192", sub_anillo: "SA3-B", nodo_l3: "N5-BUNKER01", lat: 7.3, lon: -73.8 },
            
            // UF 4 - Continuaci√≥n
            { id: 35, ruta: "4510", uf: "4", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "94+150", pkd: "188+950", sep_sos: "3.00", observacion: "SOS #19", switch_l2: "L2-189", sub_anillo: "SA3-A", nodo_l3: "N5-BUNKER01", lat: 7.33, lon: -73.77 },
            { id: 36, ruta: "4510", uf: "4", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "97+150", pkd: "185+950", sep_sos: "3.00", observacion: "SOS #20", switch_l2: "L2-186", sub_anillo: "SA3-A", nodo_l3: "N5-BUNKER01", lat: 7.36, lon: -73.74 },
            
            // UF 5 - Continuaci√≥n
            { id: 37, ruta: "4510", uf: "5", via: "Izquierda", tipo: "SOS", sistema: "POSTE SOS", pkr: "100+150", pkd: "182+950", sep_sos: "3.00", observacion: "SOS #21", switch_l2: "L2-183", sub_anillo: "SA2-B", nodo_l3: "N4-AS_PUERTO_SALGAR", lat: 7.39, lon: -73.71 },
            { id: 38, ruta: "4510", uf: "5", via: "Derecha", tipo: "SOS", sistema: "POSTE SOS", pkr: "103+150", pkd: "179+950", sep_sos: "3.00", observacion: "SOS #22", switch_l2: "L2-180", sub_anillo: "SA2-B", nodo_l3: "N4-AS_PUERTO_SALGAR", lat: 7.42, lon: -73.68 },
            
            // UF 5 - Peaje Puerto Salgar
            { id: 39, ruta: "4510", uf: "5", via: "Separador", tipo: "PEAJE", sistema: "PEAJE", pkr: "102+500", pkd: "180+600", sep_sos: "-", observacion: "Peaje Puerto Salgar", switch_l2: "L2-181", sub_anillo: "SA2-B", nodo_l3: "N4-AS_PUERTO_SALGAR", lat: 7.41, lon: -73.69 },
            
            // UF 5 - √Årea de Servicio Puerto Salgar
            { id: 40, ruta: "4510", uf: "5", via: "Separador", tipo: "AS", sistema: "AS", pkr: "103+000", pkd: "180+100", sep_sos: "-", observacion: "√Årea de Servicio Puerto Salgar", switch_l2: "L2-180", sub_anillo: "SA2-B", nodo_l3: "N4-AS_PUERTO_SALGAR", lat: 7.42, lon: -73.68 },
            
            // UF 5 - Estaci√≥n Meteorol√≥gica Peaje Puerto Salgar
            { id: 41, ruta: "4510", uf: "5", via: "Separador", tipo: "METEO", sistema: "METEO", pkr: "102+500", pkd: "180+600", sep_sos: "-", observacion: "Estaci√≥n Meteorol√≥gica Peaje Puerto Salgar", switch_l2: "L2-181", sub_anillo: "SA2-B", nodo_l3: "N4-AS_PUERTO_SALGAR", lat: 7.41, lon: -73.69 },
            
            // UF 0D - Estaci√≥n Meteorol√≥gica CCO
            { id: 42, ruta: "4510", uf: "0D", via: "Separador", tipo: "METEO", sistema: "METEO", pkr: "4+300", pkd: "4+300", sep_sos: "-", observacion: "Estaci√≥n Meteorol√≥gica CCO", switch_l2: "L2-CCO", sub_anillo: "SA-CCO", nodo_l3: "N1-CCO", lat: 6.7, lon: -74.5 },
            
            // Cajas de Fibra (muestra representativa)
            { id: 43, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "42+000", pkd: "241+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-241", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.81, lon: -74.29 },
            { id: 44, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "45+000", pkd: "238+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-238", sub_anillo: "SA7-B", nodo_l3: "N1-CCO", lat: 6.84, lon: -74.26 },
            { id: 45, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "48+000", pkd: "235+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-235", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.87, lon: -74.23 },
            { id: 46, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "51+000", pkd: "232+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-232", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.9, lon: -74.2 },
            { id: 47, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "54+000", pkd: "229+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-229", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.93, lon: -74.17 },
            { id: 48, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "57+000", pkd: "226+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-226", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.96, lon: -74.14 },
            { id: 49, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "60+000", pkd: "223+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-223", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 6.99, lon: -74.11 },
            { id: 50, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "63+000", pkd: "220+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-220", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 7.02, lon: -74.08 },
            { id: 51, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "66+000", pkd: "217+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-217", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 7.05, lon: -74.05 },
            { id: 52, ruta: "4510", uf: "0D", via: "Separador", tipo: "CAJA_FO", sistema: "FIBRA", pkr: "69+000", pkd: "214+100", sep_sos: "-", observacion: "Caja de Empalme FO", switch_l2: "L2-214", sub_anillo: "SA7-A", nodo_l3: "N7-BUNKER02", lat: 7.08, lon: -74.02 },
        ];

        let markers = [];
        let filteredData = [...layoutData];

        // Color mapping for different types
        const typeColors = {
            'SOS': '#dc3545',
            'CCTV': '#007bff',
            'PMV': '#ffc107',
            'RADAR-ANPR': '#fd7e14',
            'ETD': '#fd7e14',
            'GALIBO': '#6f42c1',
            'METEO': '#20c997',
            'WIM': '#6c757d',
            'PEAJE': '#28a745',
            'AS': '#28a745',
            'CCO': '#6f42c1',
            'CAJA_FO': '#6c757d'
        };

        // Initialize the map with all data
        function initializeMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add markers for filtered data
            filteredData.forEach(item => {
                const color = typeColors[item.tipo] || '#6c757d';
                const marker = L.circleMarker([item.lat, item.lon], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                // Add popup with equipment information
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <h4>${item.tipo} - ${item.sistema}</h4>
                        <p><strong>Ruta:</strong> ${item.ruta}</p>
                        <p><strong>UF:</strong> ${item.uf}</p>
                        <p><strong>V√≠a:</strong> ${item.via}</p>
                        <p><strong>PKR:</strong> ${item.pkr}</p>
                        <p><strong>PKD:</strong> ${item.pkd}</p>
                        <p><strong>Observaci√≥n:</strong> ${item.observacion}</p>
                        <p><strong>Switch L2:</strong> ${item.switch_l2}</p>
                        <p><strong>Sub-Anillo:</strong> ${item.sub_anillo}</p>
                        <p><strong>Nodo L3:</strong> ${item.nodo_l3}</p>
                    </div>
                `);

                markers.push(marker);
            });

            // Update statistics
            updateStatistics();
        }

        // Update statistics panel
        function updateStatistics() {
            const stats = {
                total: filteredData.length,
                SOS: filteredData.filter(item => item.tipo === 'SOS').length,
                CCTV: filteredData.filter(item => item.tipo === 'CCTV').length,
                PMV: filteredData.filter(item => item.tipo === 'PMV').length,
                ETD: filteredData.filter(item => item.tipo === 'RADAR-ANPR' || item.tipo === 'ETD').length
            };

            document.getElementById('totalEquipos').textContent = stats.total;
            document.getElementById('totalSOS').textContent = stats.SOS;
            document.getElementById('totalCCTV').textContent = stats.CCTV;
            document.getElementById('totalPMV').textContent = stats.PMV;
            document.getElementById('totalETD').textContent = stats.ETD;
        }

        // Filter layout data
        function filtrarLayout() {
            const tipoFiltro = document.getElementById('filtroTipo').value;
            const ufFiltro = document.getElementById('filtroUF').value;
            const viaFiltro = document.getElementById('filtroVia').value;

            filteredData = layoutData.filter(item => {
                const tipoMatch = tipoFiltro === 'TODOS' || item.tipo === tipoFiltro;
                const ufMatch = ufFiltro === 'TODOS' || item.uf === ufFiltro;
                const viaMatch = viaFiltro === 'TODOS' || item.via === viaFiltro;
                
                return tipoMatch && ufMatch && viaMatch;
            });

            // Update map and table
            initializeMap();
            renderTable();
        }

        // Render table with filtered data
        function renderTable() {
            const tbody = document.getElementById('layoutBody');
            tbody.innerHTML = '';

            filteredData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.ruta}</td>
                    <td>${item.uf}</td>
                    <td>${item.via}</td>
                    <td>${item.tipo}</td>
                    <td>${item.sistema}</td>
                    <td>${item.pkr}</td>
                    <td>${item.pkd}</td>
                    <td>${item.sep_sos}</td>
                    <td>${item.observacion}</td>
                    <td>${item.switch_l2}</td>
                    <td>${item.sub_anillo}</td>
                    <td>${item.nodo_l3}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Export to Excel
        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(filteredData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Layout Maestro");
            
            // Add summary sheet
            const summaryData = [
                { "Tipo": "SOS", "Cantidad": filteredData.filter(item => item.tipo === 'SOS').length },
                { "Tipo": "CCTV", "Cantidad": filteredData.filter(item => item.tipo === 'CCTV').length },
                { "Tipo": "PMV", "Cantidad": filteredData.filter(item => item.tipo === 'PMV').length },
                { "Tipo": "ETD/RADAR", "Cantidad": filteredData.filter(item => item.tipo === 'RADAR-ANPR' || item.tipo === 'ETD').length },
                { "Tipo": "METEO", "Cantidad": filteredData.filter(item => item.tipo === 'METEO').length },
                { "Tipo": "WIM", "Cantidad": filteredData.filter(item => item.tipo === 'WIM').length },
                { "Tipo": "PEAJE", "Cantidad": filteredData.filter(item => item.tipo === 'PEAJE').length },
                { "Tipo": "AS", "Cantidad": filteredData.filter(item => item.tipo === 'AS').length },
                { "Tipo": "CCO", "Cantidad": filteredData.filter(item => item.tipo === 'CCO').length },
                { "Tipo": "CAJA_FO", "Cantidad": filteredData.filter(item => item.tipo === 'CAJA_FO').length }
            ];
            const wsSummary = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen");
            
            XLSX.writeFile(wb, "WBS_Layout_Maestro_TM01.xlsx");
        }

        // Generate DT from filter
        function generarDTLayout() {
            const tipoFiltro = document.getElementById('filtroTipo').value;
            const ufFiltro = document.getElementById('filtroUF').value;
            const viaFiltro = document.getElementById('filtroVia').value;
            
            let filtros = [];
            if (tipoFiltro !== 'TODOS') filtros.push(`Tipo: ${tipoFiltro}`);
            if (ufFiltro !== 'TODOS') filtros.push(`UF: ${ufFiltro}`);
            if (viaFiltro !== 'TODOS') filtros.push(`V√≠a: ${viaFiltro}`);
            
            const dtContent = `
# DOCUMENTO T√âCNICO - LAYOUT MAESTRO
## Proyecto TM01 Troncal Magdalena

**Fecha:** ${new Date().toLocaleDateString()}
**Filtros aplicados:** ${filtros.join(', ')}
**Elementos filtrados:** ${filteredData.length}

### An√°lisis de Ubicaciones

${filteredData.map(item => `
**${item.tipo} - ${item.sistema}**
- Ruta: ${item.ruta}
- UF: ${item.uf}
- V√≠a: ${item.via}
- PKR: ${item.pkr}
- PKD: ${item.pkd}
- Observaci√≥n: ${item.observacion}
- Switch L2: ${item.switch_l2}
- Sub-Anillo: ${item.sub_anillo}
- Nodo L3: ${item.nodo_l3}
`).join('\n')}

### Recomendaciones

1. Verificar ubicaciones seg√∫n especificaciones t√©cnicas
2. Validar separaciones m√≠nimas entre equipos
3. Confirmar disponibilidad de infraestructura el√©ctrica
4. Revisar accesos para mantenimiento
            `;
            
            // Create and download DT file
            const blob = new Blob([dtContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `DT_Layout_${tipoFiltro}_${ufFiltro}_${viaFiltro}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            renderTable();
        });
    </script>
</body>
</html>